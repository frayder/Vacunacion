@model Highdmin.ViewModels.RoleViewModel

@{
    ViewData["Title"] = Model.Id == 0 ? "Crear Rol" : "Editar Rol";
    var isEdit = Model.Id != 0;
}

<div class="container-fluid px-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas @(isEdit ? "fa-edit" : "fa-plus") me-2"></i>
            @(isEdit ? "Editar Rol" : "Crear Nuevo Rol")
        </h1>
        <a asp-action="Index" class="btn btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50 me-1"></i>
            Volver a Lista
        </a>
    </div>

    <!-- Mensajes de error -->
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-cog me-2"></i>
                        Información del Rol
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="Save" method="post" id="roleForm">
                        @Html.AntiForgeryToken()
                        <input asp-for="Id" type="hidden" />

                        <!-- Información básica del rol -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Name" class="form-label">
                                        <i class="fas fa-tag me-1"></i>
                                        @Html.DisplayNameFor(m => m.Name)
                                    </label>
                                    <input asp-for="Name" class="form-control" placeholder="Ej: Administrador, Supervisor..." />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Description" class="form-label">
                                        <i class="fas fa-info-circle me-1"></i>
                                        @Html.DisplayNameFor(m => m.Description)
                                    </label>
                                    <input asp-for="Description" class="form-control" placeholder="Descripción del rol..." />
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Permisos por módulo -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-key me-2"></i>
                                        Permisos por Módulo
                                    </h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-success" onclick="selectAllPermissions()">
                                            <i class="fas fa-check-double me-1"></i>Seleccionar Todo
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="deselectAllPermissions()">
                                            <i class="fas fa-times me-1"></i>Deseleccionar Todo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                @if (Model.MenuItemPermissions != null && Model.MenuItemPermissions.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>
                                                        <i class="fas fa-cube me-1"></i>
                                                        Módulo
                                                    </th>
                                                    <th class="text-center">
                                                        <i class="fas fa-plus me-1"></i>
                                                        Crear
                                                    </th>
                                                    <th class="text-center">
                                                        <i class="fas fa-eye me-1"></i>
                                                        Leer
                                                    </th>
                                                    <th class="text-center">
                                                        <i class="fas fa-edit me-1"></i>
                                                        Actualizar
                                                    </th>
                                                    <th class="text-center">
                                                        <i class="fas fa-trash me-1"></i>
                                                        Eliminar
                                                    </th>
                                                    <th class="text-center">
                                                        <i class="fas fa-cogs me-1"></i>
                                                        Acciones
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < Model.MenuItemPermissions.Count; i++)
                                                {
                                                    <tr>
                                                        <td class="align-middle">
                                                            <strong>@Model.MenuItemPermissions[i].MenuItemName</strong>
                                                            <input asp-for="MenuItemPermissions[i].MenuItemId" type="hidden" />
                                                            <input asp-for="MenuItemPermissions[i].MenuItemName" type="hidden" />
                                                        </td>
                                                        <td class="text-center align-middle">
                                                            <div class="form-check form-switch d-flex justify-content-center">
                                                                <input asp-for="MenuItemPermissions[i].CanCreate" 
                                                                       class="form-check-input permission-checkbox" 
                                                                       type="checkbox" />
                                                            </div>
                                                        </td>
                                                        <td class="text-center align-middle">
                                                            <div class="form-check form-switch d-flex justify-content-center">
                                                                <input asp-for="MenuItemPermissions[i].CanRead" 
                                                                       class="form-check-input permission-checkbox" 
                                                                       type="checkbox" />
                                                            </div>
                                                        </td>
                                                        <td class="text-center align-middle">
                                                            <div class="form-check form-switch d-flex justify-content-center">
                                                                <input asp-for="MenuItemPermissions[i].CanUpdate" 
                                                                       class="form-check-input permission-checkbox" 
                                                                       type="checkbox" />
                                                            </div>
                                                        </td>
                                                        <td class="text-center align-middle">
                                                            <div class="form-check form-switch d-flex justify-content-center">
                                                                <input asp-for="MenuItemPermissions[i].CanDelete" 
                                                                       class="form-check-input permission-checkbox" 
                                                                       type="checkbox" />
                                                            </div>
                                                        </td>
                                                        <td class="text-center align-middle">
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-outline-success btn-sm" 
                                                                        onclick="selectRowPermissions(@i)">
                                                                    <i class="fas fa-check"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                        onclick="deselectRowPermissions(@i)">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center py-4">
                                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                                        <h6>No hay módulos disponibles</h6>
                                        <p class="text-muted">Configure primero los módulos del sistema.</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="saveButton">
                                <i class="fas fa-save me-1"></i>
                                @(isEdit ? "Actualizar Rol" : "Crear Rol")
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        function selectAllPermissions() {
            $('.permission-checkbox').prop('checked', true);
        }

        function deselectAllPermissions() {
            $('.permission-checkbox').prop('checked', false);
        }

        function selectRowPermissions(rowIndex) {
            $(`input[name*="MenuItemPermissions[${rowIndex}]"]`).prop('checked', true);
        }

        function deselectRowPermissions(rowIndex) {
            $(`input[name*="MenuItemPermissions[${rowIndex}]"]`).prop('checked', false);
        }

        // Validación del formulario
        $(document).ready(function() {
            $('#roleForm').on('submit', function(e) {
                var roleName = $('#Name').val().trim();
                if (!roleName) {
                    e.preventDefault();
                    alert('El nombre del rol es obligatorio.');
                    $('#Name').focus();
                    return false;
                }

                // Verificar si se seleccionó al menos un permiso
                var hasPermissions = $('.permission-checkbox:checked').length > 0;
                if (!hasPermissions) {
                    var confirmSave = confirm('¿Está seguro de crear un rol sin permisos? El rol no tendrá acceso a ningún módulo.');
                    if (!confirmSave) {
                        e.preventDefault();
                        return false;
                    }
                }

                // Deshabilitar botón para evitar envíos múltiples
                $('#saveButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
            });
        });
    </script>
}