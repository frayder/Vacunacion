@{
    ViewBag.Title = "Editar Usuario";
    Layout = "~/Views/Shared/_VerticalLayout.cshtml";
}

@model Highdmin.ViewModels.EditUserViewModel

<div class="row">
    <div class="col-12">
        <div class="page-title-box">
            <h4 class="page-title">Editar Usuario</h4>
        </div>
    </div>
</div>

<!-- Mostrar mensajes de éxito o error -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="ri-check-circle-line me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Información del Usuario</h5>
            </div>
            <div class="card-body">
                <!-- Mostrar resumen de todos los errores de ModelState -->
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <h6><i class="ri-alert-line me-2"></i>Por favor corrija los siguientes errores:</h6>
                        <ul class="mb-0">
                            @foreach (var modelState in ViewData.ModelState.Values)
                            {
                                @foreach (var error in modelState.Errors)
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            }
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="Edit" method="post" id="editUserForm">
                    <input type="hidden" asp-for="UserId" />
                    <input type="hidden" asp-for="PasswordHash" />
                    <input type="hidden" asp-for="PasswordSalt" />
                    <input type="hidden" asp-for="LastPasswordChange" />
                    <input type="hidden" asp-for="EmpresaId" />
                    <input type="hidden" asp-for="IsActive" />
                    
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="UserName" class="form-label">Nombre de Usuario <span class="text-danger">*</span></label>
                                <input asp-for="UserName" class="form-control" placeholder="Ingrese el nombre de usuario" required />
                                <span asp-validation-for="UserName" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input asp-for="Email" class="form-control" type="email" placeholder="usuario@ejemplo.com" required />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Campo para seleccionar rol -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label asp-for="RoleId" class="form-label">Rol <span class="text-danger">*</span></label>
                                <select asp-for="RoleId" class="form-control" required>
                                    <option value="">-- Seleccionar Rol --</option>
                                    @foreach (var role in ViewBag.Roles as List<Highdmin.Models.Role>)
                                    {
                                        <option value="@role.Id" selected="@(role.Id == Model.RoleId)">@role.Nombre - @role.Descripcion</option>
                                    }
                                </select>
                                <span asp-validation-for="RoleId" class="text-danger"></span>
                                <div class="form-text">
                                    <small>Seleccione el rol que tendrá el usuario en el sistema.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección para cambiar contraseña -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="ri-lock-line me-1"></i> Cambiar Contraseña
                                <small class="text-muted">(Opcional - Deje en blanco si no desea cambiarla)</small>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="NewPassword" class="form-label">Nueva Contraseña</label>
                                        <div class="input-group">
                                            <input asp-for="NewPassword" class="form-control" type="password"
                                                   placeholder="Ingrese nueva contraseña" minlength="8" maxlength="100" />
                                            <button type="button" class="btn btn-outline-secondary" id="toggleNewPassword">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                        </div>
                                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                                        <div class="form-text">
                                            <small>La contraseña debe tener al menos 8 caracteres.</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="ConfirmNewPassword" class="form-label">Confirmar Nueva Contraseña</label>
                                        <div class="input-group">
                                            <input asp-for="ConfirmNewPassword" class="form-control" type="password"
                                                   placeholder="Confirme la nueva contraseña" />
                                            <button type="button" class="btn btn-outline-secondary" id="toggleConfirmNewPassword">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                        </div>
                                        <span asp-validation-for="ConfirmNewPassword" class="text-danger"></span>
                                        <div id="passwordMatchMessage" class="form-text"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Indicador de fortaleza de contraseña -->
                            <div class="row" id="strengthIndicator" style="display: none;">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Fortaleza de la Contraseña</label>
                                        <div class="progress" style="height: 5px;">
                                            <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div id="strengthText" class="form-text"></div>
                                    </div>
                                </div>
                            </div>

                            @if (Model.LastPasswordChange.HasValue)
                            {
                                <div class="alert alert-info">
                                    <i class="ri-information-line me-1"></i>
                                    <strong>Último cambio de contraseña:</strong> @Model.LastPasswordChange.Value.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mb-3 mt-3">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="ri-save-line me-1"></i> Actualizar Usuario
                        </button>
                        <a asp-action="Index" class="btn btn-secondary ms-2">
                            <i class="ri-arrow-left-line me-1"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel de debug -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="ri-bug-line me-1"></i>Debug - Estado del Modelo
                </h6>
            </div>
            <div class="card-body">
                <p><strong>ModelState.IsValid:</strong> <span class="badge badge-@(ViewData.ModelState.IsValid ? "success" : "danger")">@ViewData.ModelState.IsValid</span></p>
                <p><strong>Modelo actual:</strong></p>
                <ul class="small">
                    <li><strong>UserId:</strong> @Model.UserId</li>
                    <li><strong>UserName:</strong> @(Model?.UserName ?? "null")</li>
                    <li><strong>Email:</strong> @(Model?.Email ?? "null")</li>
                    <li><strong>RoleId:</strong> @Model.RoleId</li>
                </ul>
                
                @if (ViewBag.Roles != null)
                {
                    <div class="mt-3">
                        <strong>Roles disponibles:</strong>
                        <div class="small mt-2">
                            @foreach (var role in ViewBag.Roles as List<Highdmin.Models.Role>)
                            {
                                <div class="alert alert-@(role.Id == Model.RoleId ? "success" : "info") py-1 px-2 mb-1">
                                    <strong>@role.Id:</strong> @role.Nombre
                                    @if (role.Id == Model.RoleId)
                                    {
                                        <span class="badge bg-success ms-2">ACTUAL</span>
                                    }
                                    @if (!string.IsNullOrEmpty(role.Descripcion))
                                    {
                                        <br><small>@role.Descripcion</small>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                
                @if (ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
                {
                    <div class="mt-3">
                        <strong>Errores detallados:</strong>
                        <div class="small mt-2">
                            @foreach (var kvp in ViewData.ModelState)
                            {
                                if (kvp.Value.Errors.Any())
                                {
                                    <div class="alert alert-warning py-1 px-2 mb-1">
                                        <strong>@kvp.Key:</strong>
                                        <ul class="mb-0 ms-3">
                                            @foreach (var error in kvp.Value.Errors)
                                            {
                                                <li>@error.ErrorMessage</li>
                                            }
                                        </ul>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            console.log('Edit form loaded, debugging enabled');
            
            // Toggle password visibility
            $('#toggleNewPassword').click(function() {
                togglePasswordVisibility('#NewPassword', $(this).find('i'));
            });
            
            $('#toggleConfirmNewPassword').click(function() {
                togglePasswordVisibility('#ConfirmNewPassword', $(this).find('i'));
            });

            function togglePasswordVisibility(fieldSelector, iconElement) {
                const passwordField = $(fieldSelector);
                
                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    iconElement.removeClass('ri-eye-line').addClass('ri-eye-off-line');
                } else {
                    passwordField.attr('type', 'password');
                    iconElement.removeClass('ri-eye-off-line').addClass('ri-eye-line');
                }
            }

            // Password strength checker
            $('#NewPassword').on('input', function() {
                const password = $(this).val();
                
                if (password.length > 0) {
                    $('#strengthIndicator').show();
                    const strength = checkPasswordStrength(password);
                    updatePasswordStrength(strength);
                } else {
                    $('#strengthIndicator').hide();
                }
                
                validatePasswordMatch();
            });

            $('#ConfirmNewPassword').on('input', function() {
                validatePasswordMatch();
            });

            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = [];

                if (password.length >= 8) score += 20;
                else feedback.push("Al menos 8 caracteres");

                if (password.match(/[a-z]/)) score += 20;
                else feedback.push("Letras minúsculas");

                if (password.match(/[A-Z]/)) score += 20;
                else feedback.push("Letras mayúsculas");

                if (password.match(/[0-9]/)) score += 20;
                else feedback.push("Números");

                if (password.match(/[^a-zA-Z0-9]/)) score += 20;
                else feedback.push("Símbolos especiales");

                return { score: score, feedback: feedback };
            }

            function updatePasswordStrength(strength) {
                const progressBar = $('#passwordStrength');
                const strengthText = $('#strengthText');

                let className = 'bg-danger';
                let text = 'Muy débil';

                if (strength.score >= 80) {
                    className = 'bg-success';
                    text = 'Muy fuerte';
                } else if (strength.score >= 60) {
                    className = 'bg-info';
                    text = 'Fuerte';
                } else if (strength.score >= 40) {
                    className = 'bg-warning';
                    text = 'Media';
                } else if (strength.score >= 20) {
                    className = 'bg-orange';
                    text = 'Débil';
                }

                progressBar.removeClass('bg-danger bg-warning bg-info bg-success bg-orange')
                          .addClass(className)
                          .css('width', strength.score + '%');

                if (strength.feedback.length > 0) {
                    strengthText.html(text + ' - Falta: ' + strength.feedback.join(', '));
                } else {
                    strengthText.text(text);
                }
            }

            function validatePasswordMatch() {
                const newPassword = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmNewPassword').val();
                const matchMessage = $('#passwordMatchMessage');
                const submitBtn = $('#submitBtn');

                if (newPassword.length > 0 && confirmPassword.length > 0) {
                    if (newPassword === confirmPassword) {
                        matchMessage.html('<span class="text-success"><i class="ri-check-line"></i> Las contraseñas coinciden</span>');
                        submitBtn.prop('disabled', false);
                    } else {
                        matchMessage.html('<span class="text-danger"><i class="ri-close-line"></i> Las contraseñas no coinciden</span>');
                        submitBtn.prop('disabled', true);
                    }
                } else {
                    matchMessage.text('');
                    submitBtn.prop('disabled', false);
                }
            }

            // Form validation before submit
            $('#editUserForm').on('submit', function(e) {
                const userName = $('#UserName').val();
                const email = $('#Email').val();
                const roleId = $('#RoleId').val();
                const newPassword = $('#NewPassword').val();
                const confirmPassword = $('#ConfirmNewPassword').val();

                console.log('=== FORM SUBMISSION DEBUG ===');
                console.log('UserName:', userName);
                console.log('Email:', email);
                console.log('RoleId:', roleId);
                console.log('New Password provided:', !!newPassword);

                if (!userName) {
                    e.preventDefault();
                    alert('El nombre de usuario es requerido.');
                    return false;
                }

                if (!email) {
                    e.preventDefault();
                    alert('El email es requerido.');
                    return false;
                }

                if (!roleId) {
                    e.preventDefault();
                    alert('Debe seleccionar un rol.');
                    return false;
                }

                // Solo validar contraseñas si se está intentando cambiarla
                if (newPassword.length > 0 || confirmPassword.length > 0) {
                    if (newPassword !== confirmPassword) {
                        e.preventDefault();
                        alert('Las contraseñas no coinciden. Por favor verifique.');
                        return false;
                    }

                    if (newPassword.length < 8) {
                        e.preventDefault();
                        alert('La nueva contraseña debe tener al menos 8 caracteres.');
                        return false;
                    }
                }

                console.log('Client-side validation passed, submitting form...');
            });
        });
    </script>
    
    <style>
        .bg-orange {
            background-color: #fd7e14 !important;
        }
        
        .input-group .btn-outline-secondary {
            border-left: 0;
        }
        
        .form-text small {
            font-size: 0.825em;
        }
        
        .card-header h6 {
            margin-bottom: 0;
        }

        .alert ul {
            padding-left: 1.2rem;
        }

        .badge-success {
            background-color: #28a745;
        }

        .badge-danger {
            background-color: #dc3545;
        }
    </style>
}