@model RegistroVacunacionItemViewModel

<div class="card border-0">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0 text-white">
            <i class="ri-vaccine-line me-1"></i> Esquema        function mostrarOcultarDetasetInterval(function() {
         // Observer simple como respaldo
        let lastValue = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== lastValue) {
                console.log('üîç OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                mostrarOcultarDetalles();
            }
        }, 100);  if (vacunaSelect.value !== lastValue) {
                console.log('üîç OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                mostrarOcultarDetalles();
            }
        }, 100);         const valor = vacunaSelect.value;
            console.log('Verificando valor:', valor);
            
            if (valor && valor !== '') {
                // Usar la misma t√©cnica del SUPER TEST que sabemos que funciona
                detallesVacuna.style.display = 'block';
                detallesVacuna.style.visibility = 'visible';
                detallesVacuna.style.setProperty('display', 'block', 'important');
                console.log('‚úÖ Detalles mostrados');
            } else {
                detallesVacuna.style.setProperty('display', 'none', 'important');
                console.log('‚ùå Detalles ocultados');
            }
        }n
        </h6>
    </div>
    <div class="card-body">


        <!-- Tipo de carn√©t -->
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label class="form-label">Tipo de carn√©t</label>
                    <select class="form-select" name="TipoCarnet" id="tipoCarnet">
                        <option value="">Seleccione tipo de carn√©t</option>
                        <!-- Las opciones se cargar√°n din√°micamente desde la base de datos -->
                    </select>
                    <div id="tipoCarnetLoading" class="text-muted small mt-1" style="display: none;">
                        <i class="ri-loader-2-line"></i> Cargando tipos de carnet...
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Agregar Vacuna Aplicada -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="ri-add-circle-line text-primary me-2"></i>
                    <h6 class="mb-0 text-primary fw-bold">Agregar Vacuna Aplicada</h6>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar Vacunas <span class="text-danger">*</span></label>
                            <select class="form-select" name="VacunaSeleccionada" id="VacunaSeleccionada" required onchange="document.getElementById('detallesVacuna').style.display = this.value ? 'block' : 'none'">
                                <option value="">Seleccione la vacuna aplicada</option>
                                <optgroup label="Vacunas del PAI">
                                    <option value="BCG">BCG (Bacilo de Calmette y Gu√©rin)</option>
                                    <option value="HEPATITIS_B">Hepatitis B</option>
                                    <option value="PENTAVALENTE">Pentavalente (DPT + HepB + Hib)</option>
                                    <option value="POLIO_IPV">Polio IPV (Inactivada)</option>
                                    <option value="POLIO_OPV">Polio OPV (Oral)</option>
                                    <option value="ROTAVIRUS">Rotavirus</option>
                                    <option value="NEUMOCOCO">Neumococo</option>
                                    <option value="INFLUENZA">Influenza</option>
                                    <option value="SRP">SRP (Sarampi√≥n, Rub√©ola, Parotiditis)</option>
                                    <option value="VARICELA">Varicela</option>
                                    <option value="HEPATITIS_A">Hepatitis A</option>
                                    <option value="DPT">DPT (Difteria, Pertussis, T√©tanos)</option>
                                    <option value="TD">Td (T√©tanos, Difteria)</option>
                                    <option value="VPH">VPH (Virus del Papiloma Humano)</option>
                                </optgroup>
                                <optgroup label="Vacunas Especiales">
                                    <option value="COVID19_PFIZER">COVID-19 Pfizer</option>
                                    <option value="COVID19_MODERNA">COVID-19 Moderna</option>
                                    <option value="COVID19_ASTRAZENECA">COVID-19 AstraZeneca</option>
                                    <option value="COVID19_JANSSEN">COVID-19 Janssen</option>
                                    <option value="COVID19_SINOVAC">COVID-19 Sinovac</option>
                                    <option value="FIEBRE_AMARILLA">Fiebre Amarilla</option>
                                    <option value="MENINGITIS">Meningitis</option>
                                    <option value="ENCEFALITIS_JAPONESA">Encefalitis Japonesa</option>
                                </optgroup>
                                <optgroup label="Otras">
                                    <option value="OTRA">Otra vacuna</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Campos adicionales que aparecen al seleccionar una vacuna -->
                <div id="detallesVacuna" style="display: none;">
                    <div class="alert alert-info">
                        <i class="ri-information-line me-1"></i>
                        <strong>Informaci√≥n de la Vacuna:</strong> Complete los siguientes datos de la vacuna seleccionada.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">N√∫mero de dosis <span class="text-danger">*</span></label>
                                <select class="form-select" name="NumeroDosis" required>
                                    <option value="">Seleccione...</option>
                                    <option value="1">Primera dosis</option>
                                    <option value="2">Segunda dosis</option>
                                    <option value="3">Tercera dosis</option>
                                    <option value="4">Cuarta dosis</option>
                                    <option value="REFUERZO">Refuerzo</option>
                                    <option value="UNICA">Dosis √∫nica</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Fecha de aplicaci√≥n <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="FechaAplicacion" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Lote</label>
                                <input type="text" class="form-control" name="LoteVacuna" placeholder="N√∫mero de lote">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Laboratorio</label>
                                <input type="text" class="form-control" name="Laboratorio" placeholder="Laboratorio fabricante">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">V√≠a de administraci√≥n</label>
                                <select class="form-select" name="ViaAdministracion">
                                    <option value="">Seleccione...</option>
                                    <option value="INTRAMUSCULAR">Intramuscular</option>
                                    <option value="SUBCUTANEA">Subcut√°nea</option>
                                    <option value="ORAL">Oral</option>
                                    <option value="INTRADERMICA">Intrad√©rmica</option>
                                    <option value="NASAL">Nasal</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sitio de aplicaci√≥n</label>
                                <select class="form-select" name="SitioAplicacion">
                                    <option value="">Seleccione...</option>
                                    <option value="BRAZO_IZQUIERDO">Brazo izquierdo</option>
                                    <option value="BRAZO_DERECHO">Brazo derecho</option>
                                    <option value="MUSLO_IZQUIERDO">Muslo izquierdo</option>
                                    <option value="MUSLO_DERECHO">Muslo derecho</option>
                                    <option value="ORAL">V√≠a oral</option>
                                    <option value="NASAL">V√≠a nasal</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Observaciones</label>
                                <textarea class="form-control" name="ObservacionesVacuna" rows="3" placeholder="Observaciones sobre la vacuna aplicada..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="agregarVacuna()" id="btnAgregarVacuna">
                            <i class="ri-add-line me-1"></i> Agregar Vacuna
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de vacunas agregadas -->
        <div id="vacunasAplicadas" class="mt-4" style="display: none;">
            <h6 class="fw-bold text-primary mb-3">
                <i class="ri-list-check me-1"></i> Vacunas Aplicadas
            </h6>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Vacuna</th>
                            <th>Dosis</th>
                            <th>Fecha</th>
                            <th>Lote</th>
                            <th>Laboratorio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaVacunas">
                        <!-- Las vacunas se agregar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// SOLUCI√ìN DIRECTA CON JAVASCRIPT NATIVO - M√°s confiable
function configurarEventosVacuna() {
    console.log('üöÄ CONFIGURANDO EVENTOS DE VACUNA...');
    
    const vacunaSelect = document.getElementById('VacunaSeleccionada');
    const detallesVacuna = document.getElementById('detallesVacuna');
    
    console.log('üìã Elementos encontrados:');
    console.log('  - vacunaSelect:', vacunaSelect);
    console.log('  - detallesVacuna:', detallesVacuna);
    
    if (vacunaSelect && detallesVacuna) {
        console.log('‚úÖ ELEMENTOS ENCONTRADOS - Configurando eventos...');
        
        // Funci√≥n principal para mostrar/ocultar
        function toggleDetalles() {
            const valor = vacunaSelect.value;
            console.log('üéØ EVENTO CHANGE - Valor seleccionado:', valor);
            
            if (valor && valor.trim() !== '') {
                console.log('‚úÖ MOSTRANDO detalles para:', valor);
                detallesVacuna.style.display = 'block';
                detallesVacuna.style.visibility = 'visible';
                detallesVacuna.classList.remove('d-none');
                
                // Forzar el display
                detallesVacuna.removeAttribute('hidden');
                detallesVacuna.style.setProperty('display', 'block', 'important');
                
                console.log('üìä Estado final display:', window.getComputedStyle(detallesVacuna).display);
            } else {
                console.log('‚ùå OCULTANDO detalles');
                detallesVacuna.style.display = 'none';
                detallesVacuna.style.visibility = 'hidden';
                detallesVacuna.classList.add('d-none');
            }
        }
        
        // Limpiar cualquier event listener previo
        vacunaSelect.onchange = null;
        vacunaSelect.oninput = null;
        
        // Asignar eventos m√∫ltiples
        vacunaSelect.addEventListener('change', toggleDetalles);
        vacunaSelect.addEventListener('input', toggleDetalles);
        vacunaSelect.onchange = toggleDetalles;
        
        // Observer como respaldo MEJORADO
        let ultimoValor = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== ultimoValor) {
                console.log('üîç OBSERVER: Cambio detectado', ultimoValor, '‚Üí', vacunaSelect.value);
                ultimoValor = vacunaSelect.value;
                toggleDetalles();
            }
        }, 50); // M√°s frecuente
        
        // Verificar estado inicial
        if (vacunaSelect.value && vacunaSelect.value.trim() !== '') {
            console.log('ÔøΩ ESTADO INICIAL - Valor preseleccionado:', vacunaSelect.value);
            toggleDetalles();
        }
        
        console.log('‚úÖ EVENTOS CONFIGURADOS CORRECTAMENTE');
        
        // Funci√≥n de prueba global
        window.probarVacunaManual = function(valor) {
            vacunaSelect.value = valor || 'BCG';
            toggleDetalles();
            console.log('üéØ PRUEBA MANUAL EJECUTADA');
        };
        
    } else {
        console.error('‚ùå ERROR: No se encontraron los elementos necesarios');
        console.log('Buscando elementos alternativos...');
        
        // Buscar por otros selectores
        const alternativo1 = document.querySelector('select[name="VacunaSeleccionada"]');
        const alternativo2 = document.querySelector('#detallesVacuna');
        
        console.log('Elementos alternativos:');
        console.log('  - Por name:', alternativo1);
        console.log('  - Por ID detalles:', alternativo2);
    }
}

// Ejecutar inmediatamente y con m√∫ltiples estrategias
configurarEventosVacuna();

// Ejecutar despu√©s de un delay
setTimeout(configurarEventosVacuna, 100);
setTimeout(configurarEventosVacuna, 500);

// Si hay jQuery disponible, usarlo tambi√©n
if (typeof $ !== 'undefined') {
    $(document).ready(function() {
        console.log('üîÑ RESPALDO JQUERY - Configurando...');
        setTimeout(configurarEventosVacuna, 100);
    });
}

// RESPALDO: Funci√≥n que inicializa los event listeners (JavaScript nativo)
function inicializarEventListenersNativo() {
    console.log('üîÑ RESPALDO - Inicializando con JavaScript nativo...');
    
    const vacunaSelect = document.getElementById('VacunaSeleccionada');
    const detallesVacuna = document.getElementById('detallesVacuna');
    
    console.log('üìã Elementos encontrados:');
    console.log('  - vacunaSelect:', vacunaSelect);
    console.log('  - detallesVacuna:', detallesVacuna);
    if (vacunaSelect && detallesVacuna) {
        console.log('‚úÖ ELEMENTOS ENCONTRADOS (Nativo) - Configurando event listeners...');
        console.log('  - vacunaSelect.id:', vacunaSelect.id);
        console.log('  - detallesVacuna.id:', detallesVacuna.id);
        
        // Funci√≥n para mostrar/ocultar detalles (ahora global)
        window.toggleDetallesVacuna = function() {
            const select = document.getElementById('VacunaSeleccionada');
            const detalles = document.getElementById('detallesVacuna');
            
            if (!select || !detalles) {
                console.error('No se encontraron los elementos necesarios');
                return;
            }
            
            const valor = select.value;
            console.log('Vacuna seleccionada:', valor);
            
            if (valor && valor !== '') {
                detalles.style.setProperty('display', 'block', 'important');
                detalles.style.setProperty('visibility', 'visible', 'important');
                console.log('Mostrando detalles de vacuna');
            } else {
                detalles.style.setProperty('display', 'none', 'important');
                console.log('Ocultando detalles de vacuna');
            }
        };
        
        // Event listener S√öPER SIMPLE
        function handleVacunaChange() {
            console.log('ÔøΩ EVENTO DISPARADO - Valor actual:', vacunaSelect.value);
            
            if (vacunaSelect.value) {
                console.log('‚úÖ Hay valor, mostrando detalles...');
                detallesVacuna.style.display = 'block';
            } else {
                console.log('‚ùå No hay valor, ocultando detalles...');
                detallesVacuna.style.display = 'none';
            }
            
            console.log('üìä Display final:', detallesVacuna.style.display);
        }
        
        // Funci√≥n principal para mostrar/ocultar detalles
        function mostrarOcultarDetalles() {
            const valor = vacunaSelect.value;
            console.log('üîç mostrarOcultarDetalles - Valor:', valor);
            
            if (valor && valor !== '') {
                console.log('‚úÖ MOSTRANDO detalles');
                detallesVacuna.style.display = 'block';
                detallesVacuna.classList.remove('d-none');
            } else {
                console.log('‚ùå OCULTANDO detalles');
                detallesVacuna.style.display = 'none';
                detallesVacuna.classList.add('d-none');
            }
        }
        
        // Event listeners m√∫ltiples
        console.log('üîß Asignando event listeners...');
        
        vacunaSelect.onchange = function() {
            console.log('üéØ ONCHANGE DISPARADO - Valor:', this.value);
            mostrarOcultarDetalles();
        };
        
        vacunaSelect.addEventListener('change', function() {
            console.log('üéØ ADDEVENTLISTENER CHANGE - Valor:', this.value);
            mostrarOcultarDetalles();
        });
        
        vacunaSelect.addEventListener('input', function() {
            console.log('üéØ ADDEVENTLISTENER INPUT - Valor:', this.value);
            mostrarOcultarDetalles();
        });
        
        // Observer simple como respaldo
        let lastValue = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== lastValue) {
                console.log('ÔøΩ OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                handleVacunaChange();
            }
        }, 200);
        
        // Verificar estado inicial
        if (vacunaSelect.value) {
            detallesVacuna.style.setProperty('display', 'block', 'important');
            console.log('Vacuna preseleccionada, mostrando detalles');
        }
        
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios:', {
            vacunaSelect: !!vacunaSelect,
            detallesVacuna: !!detallesVacuna,
            vacunaSelectId: vacunaSelect ? vacunaSelect.id : 'null',
            detallesVacunaId: detallesVacuna ? detallesVacuna.id : 'null'
        });
    }
    
    // Verificar elementos del DOM
    console.log('Elementos DOM cargados correctamente');
    
    // Funci√≥n global para testing manual
    window.testVacunaToggle = function() {
        const detalles = document.getElementById('detallesVacuna');
        const currentDisplay = window.getComputedStyle(detalles).display;
        console.log('Display actual:', currentDisplay);
        
        if (currentDisplay === 'none') {
            detalles.style.setProperty('display', 'block', 'important');
            alert('Intentando mostrar detalles');
        } else {
            detalles.style.setProperty('display', 'none', 'important');
            alert('Intentando ocultar detalles');
        }
    };
    
    // Event listener adicional para el bot√≥n
    const btnAgregar = document.getElementById('btnAgregarVacuna');
    if (btnAgregar) {
        btnAgregar.addEventListener('click', function(e) {
            e.preventDefault();
            agregarVacuna();
        });
    }
}

console.log('üéØ PASO 6 - ESQUEMA VACUNACI√ìN INICIALIZADO');

let contadorVacunas = 0;

// Hacer la funci√≥n global
window.agregarVacuna = function() {
    console.log('Agregando vacuna...');
    
    try {
        const vacunaSelect = document.querySelector('[name="VacunaSeleccionada"]');
        const dosisSelect = document.querySelector('[name="NumeroDosis"]');
        const fechaInput = document.querySelector('[name="FechaAplicacion"]');
        const loteInput = document.querySelector('[name="LoteVacuna"]');
        const laboratorioInput = document.querySelector('[name="Laboratorio"]');
        
        if (!vacunaSelect || !dosisSelect || !fechaInput) {
            console.error('No se encontraron todos los elementos del formulario');
            alert('Error: No se pudieron encontrar los elementos del formulario');
            return;
        }
    
    const vacuna = vacunaSelect.value;
    const vacunaTexto = vacunaSelect.options[vacunaSelect.selectedIndex].text;
    const dosis = dosisSelect.value;
    const dosisTexto = dosisSelect.options[dosisSelect.selectedIndex].text;
    const fecha = fechaInput.value;
    const lote = loteInput ? loteInput.value : '';
    const laboratorio = laboratorioInput ? laboratorioInput.value : '';
    
    if (!vacuna || !dosis || !fecha) {
        alert('Por favor complete los campos obligatorios: Vacuna, Dosis y Fecha');
        return;
    }
    
    const tablaVacunas = document.getElementById('tablaVacunas');
    if (!tablaVacunas) {
        console.error('No se encontr√≥ la tabla de vacunas');
        return;
    }
    
    const nuevaFila = document.createElement('tr');
    nuevaFila.innerHTML = `
        <td>${vacunaTexto}</td>
        <td>${dosisTexto}</td>
        <td>${fecha}</td>
        <td>${lote}</td>
        <td>${laboratorio}</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarVacuna(this)">
                <i class="ri-delete-bin-line"></i>
            </button>
        </td>
    `;
    
    tablaVacunas.appendChild(nuevaFila);
    
    // Mostrar la tabla de vacunas aplicadas
    const vacunasAplicadas = document.getElementById('vacunasAplicadas');
    if (vacunasAplicadas) {
        vacunasAplicadas.style.display = 'block';
    }
    
    // Limpiar el formulario usando jQuery si est√° disponible
    if (typeof jQuery !== 'undefined') {
        console.log('üßπ Limpiando formulario con jQuery...');
        $('#VacunaSeleccionada').val('').trigger('change');
        $('[name="NumeroDosis"]').val('');
        $('[name="FechaAplicacion"]').val('');
        $('[name="LoteVacuna"]').val('');
        $('[name="Laboratorio"]').val('');
        $('[name="ViaAdministracion"]').val('');
        $('[name="SitioAplicacion"]').val('');
        $('[name="ObservacionesVacuna"]').val('');
        
        // Los detalles se ocultar√°n autom√°ticamente por el trigger('change')
    } else {
        // Fallback JavaScript nativo
        vacunaSelect.value = '';
        dosisSelect.value = '';
        fechaInput.value = '';
        if (loteInput) loteInput.value = '';
        if (laboratorioInput) laboratorioInput.value = '';
        
        const viaSelect = document.querySelector('[name="ViaAdministracion"]');
        const sitioSelect = document.querySelector('[name="SitioAplicacion"]');
        const observacionesTextarea = document.querySelector('[name="ObservacionesVacuna"]');
        
        if (viaSelect) viaSelect.value = '';
        if (sitioSelect) sitioSelect.value = '';
        if (observacionesTextarea) observacionesTextarea.value = '';
        
        // Ocultar los detalles
        const detallesVacuna = document.getElementById('detallesVacuna');
        if (detallesVacuna) {
            detallesVacuna.style.display = 'none';
        }
    }
    
    contadorVacunas++;
    console.log('Vacuna agregada exitosamente, total:', contadorVacunas);
    
    } catch (error) {
        console.error('Error en agregarVacuna:', error);
        alert('Error al agregar vacuna: ' + error.message);
    }
}

window.eliminarVacuna = function(boton) {
    if (confirm('¬øEst√° seguro de que desea eliminar esta vacuna?')) {
        const fila = boton.closest('tr');
        fila.remove();
        
        // Si no quedan vacunas, ocultar la tabla
        const tablaVacunas = document.getElementById('tablaVacunas');
        if (tablaVacunas.children.length === 0) {
            document.getElementById('vacunasAplicadas').style.display = 'none';
        }
    }
}

// Funci√≥n de validaci√≥n para este paso
function validateEsquemaVacunacion() {
    let isValid = true;
    let errors = [];

    // Validar que al menos hay una vacuna registrada
    const tablaVacunas = document.getElementById('tablaVacunas');
    const filasVacunas = tablaVacunas.children.length;

    if (filasVacunas === 0) {
        isValid = false;
        errors.push('Debe registrar al menos una vacuna');
    }

    // Mostrar errores si los hay
    if (!isValid) {
        alert('Por favor complete los siguientes campos:\n\n' + errors.join('\n'));
    }

    return isValid;
}

// Exponer la funci√≥n globalmente para el validador de pasos
window.validateEsquemaVacunacion = validateEsquemaVacunacion;
</script>