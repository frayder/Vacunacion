@model RegistroVacunacionItemViewModel

<div class="card border-0">
    <div class="card-header bg-primary text-white"> 
        <div class="d-flex align-items-center">
            <i class="ri-shield-check-line me-2"></i>
            <h5 class="mb-0">Esquema de Vacunación</h5>
        </div>
    </div>
    <div class="card-body">


        <!-- Tipo de carnét -->
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label class="form-label">Tipo de carnét</label>
                    <select class="form-select" name="TipoCarnetId" id="tipoCarnet">
                        <option value="">Seleccione tipo de carnét</option>
                        <!-- Las opciones se cargarán dinámicamente desde la base de datos -->
                    </select>
                    <div id="tipoCarnetLoading" class="text-muted small mt-1" style="display: none;">
                        <i class="ri-loader-2-line"></i> Cargando tipos de carnet...
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Agregar Vacuna Aplicada -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="ri-add-circle-line text-primary me-2"></i>
                    <h6 class="mb-0 text-primary fw-bold">Agregar Vacuna Aplicada</h6>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar Vacunas <span class="text-danger">*</span></label>
                            <select class="form-select" name="Vacuna" id="VacunaSeleccionada" required
                                onchange="document.getElementById('detallesVacuna').style.display = this.value ? 'block' : 'none'">
                                <option value="">Seleccione la vacuna aplicada</option>
                                <optgroup label="Vacunas del PAI">
                                    <option value="BCG">BCG (Bacilo de Calmette y Guérin)</option>
                                    <option value="HEPATITIS_B">Hepatitis B</option>
                                    <option value="PENTAVALENTE">Pentavalente (DPT + HepB + Hib)</option>
                                    <option value="POLIO_IPV">Polio IPV (Inactivada)</option>
                                    <option value="POLIO_OPV">Polio OPV (Oral)</option>
                                    <option value="ROTAVIRUS">Rotavirus</option>
                                    <option value="NEUMOCOCO">Neumococo</option>
                                    <option value="INFLUENZA">Influenza</option>
                                    <option value="SRP">SRP (Sarampión, Rubéola, Parotiditis)</option>
                                    <option value="VARICELA">Varicela</option>
                                    <option value="HEPATITIS_A">Hepatitis A</option>
                                    <option value="DPT">DPT (Difteria, Pertussis, Tétanos)</option>
                                    <option value="TD">Td (Tétanos, Difteria)</option>
                                    <option value="VPH">VPH (Virus del Papiloma Humano)</option>
                                </optgroup>
                                <optgroup label="Vacunas Especiales">
                                    <option value="COVID19_PFIZER">COVID-19 Pfizer</option>
                                    <option value="COVID19_MODERNA">COVID-19 Moderna</option>
                                    <option value="COVID19_ASTRAZENECA">COVID-19 AstraZeneca</option>
                                    <option value="COVID19_JANSSEN">COVID-19 Janssen</option>
                                    <option value="COVID19_SINOVAC">COVID-19 Sinovac</option>
                                    <option value="FIEBRE_AMARILLA">Fiebre Amarilla</option>
                                    <option value="MENINGITIS">Meningitis</option>
                                    <option value="ENCEFALITIS_JAPONESA">Encefalitis Japonesa</option>
                                </optgroup>
                                <optgroup label="Otras">
                                    <option value="OTRA">Otra vacuna</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6" id="detallesVacuna">
                        <div class="mb-3">
                            <label class="form-label">Número de dosis <span class="text-danger">*</span></label>
                            <select class="form-select" name="Dosis" required>
                                <option value="">Seleccione...</option>
                                <option value="1">Primera dosis</option>
                                <option value="2">Segunda dosis</option>
                                <option value="3">Tercera dosis</option>
                                <option value="4">Cuarta dosis</option>
                                <option value="REFUERZO">Refuerzo</option>
                                <option value="UNICA">Dosis única</option>
                            </select>
                        </div>
                    </div>
                </div>

                 <!-- Checkbox Marcar como perdida -->
                <div class="row">
                    <div class="col-12">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="MarcarComoPerdida"
                                name="MarcarComoPerdida" onchange="document.getElementById('motivoPerdidaContainer').style.display = this.checked ? 'block' : 'none'">
                            <label class="form-check-label text-warning fw-bold" for="MarcarComoPerdida">
                                <i class="ri-alert-line me-1"></i>
                                Marcar como perdida
                            </label>
                        </div>
                        <div class="alert alert-warning border-0 bg-warning-subtle mb-3" role="alert">
                            <div class="d-flex align-items-start">
                                <i class="ri-information-line text-warning me-2 mt-1"></i>
                                <div class="text-warning">
                                    <small>Al marcar como perdida, la vacuna se descontará del inventario pero no se registrará como aplicada al paciente.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 

                <!-- Motivo de la pérdida (oculto por defecto) -->
                <div class="row" id="motivoPerdidaContainer" style="display: none;">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label">Motivo de la pérdida <span class="text-danger">*</span></label>
                            <select class="form-select" name="MotivoPerdida" id="MotivoPerdida">
                                <option value="">Seleccione el motivo de la pérdida</option>
                                <option value="VENCIMIENTO">Vencimiento</option>
                                <option value="RUPTURA">Ruptura del frasco</option>
                                <option value="CADENA_FRIO">Ruptura de cadena de frío</option>
                                <option value="CONTAMINACION">Contaminación</option>
                                <option value="ERROR_PREPARACION">Error en la preparación</option>
                                <option value="OTRO">Otro motivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Información de rangos de edad (se muestra al seleccionar vacuna) -->
                <div id="informacionRangosEdad">
                    <div class="alert alert-info border-0 bg-info-subtle" role="alert">
                        <h6 class="alert-heading mb-2 text-info">
                            <i class="ri-information-line me-1"></i>
                            <span id="tituloInformacion">Información de rangos de edad para</span>
                        </h6>
                        <div id="contenidoInformacion" class="text-info">
                            <!-- El contenido se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Alerta específica de edad -->
                    <div id="alertaEdad" class="alert alert-warning border-0 bg-warning-subtle" style="display: none;" role="alert">
                        <div class="d-flex align-items-start">
                            <i class="ri-alert-line text-warning me-2 mt-1"></i>
                            <div class="text-warning">
                                <div id="mensajeAlerta" class="mb-2"></div>
                                <div id="dosisRecomendada" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
    // SOLUCIÓN DIRECTA CON JAVASCRIPT NATIVO - Más confiable
    function configurarEventosVacuna() {
        const vacunaSelect = document.getElementById('VacunaSeleccionada');
        const detallesVacuna = document.getElementById('detallesVacuna');

        if (vacunaSelect && detallesVacuna) {
            // Función principal para mostrar/ocultar
            function toggleDetalles() {
                const valor = vacunaSelect.value;

                if (valor && valor.trim() !== '') {
                    detallesVacuna.style.display = 'block';
                    detallesVacuna.style.visibility = 'visible';
                    detallesVacuna.classList.remove('d-none');
                    detallesVacuna.removeAttribute('hidden');
                    detallesVacuna.style.setProperty('display', 'block', 'important');
                } else {
                    detallesVacuna.style.display = 'none';
                    detallesVacuna.style.visibility = 'hidden';
                    detallesVacuna.classList.add('d-none');
                }
            }

            // Limpiar cualquier event listener previo
            vacunaSelect.onchange = null;
            vacunaSelect.oninput = null;

            // Asignar eventos múltiples
            vacunaSelect.addEventListener('change', toggleDetalles);
            vacunaSelect.addEventListener('input', toggleDetalles);
            vacunaSelect.onchange = toggleDetalles;

            // Observer como respaldo MEJORADO
            let ultimoValor = vacunaSelect.value;
            setInterval(function () {
                if (vacunaSelect.value !== ultimoValor) {
                    ultimoValor = vacunaSelect.value;
                    toggleDetalles();
                }
            }, 50);

            // Verificar estado inicial
            if (vacunaSelect.value && vacunaSelect.value.trim() !== '') {
                toggleDetalles();
            }

            // Función de prueba global
            window.probarVacunaManual = function (valor) {
                vacunaSelect.value = valor || 'BCG';
                toggleDetalles();
            };
        }
    }

    // Función para toggle del motivo de pérdida
    function toggleMotivoPerdida() {
        const checkbox = document.getElementById('MarcarComoPerdida');
        const container = document.getElementById('motivoPerdidaContainer');
        const select = document.getElementById('MotivoPerdida'); 
        if (checkbox.checked) {
            container.style.display = 'block';
            select.required = true;
        } else {
            container.style.display = 'none';
            select.required = false;
            select.value = '';
        }
    }

    // Ejecutar inmediatamente y con múltiples estrategias
    configurarEventosVacuna();
    setTimeout(configurarEventosVacuna, 100);
    setTimeout(configurarEventosVacuna, 500);

    // Si hay jQuery disponible, usarlo también
    if (typeof $ !== 'undefined') {
        $(document).ready(function () {
            setTimeout(configurarEventosVacuna, 100);
        });
    }

    console.log('🎯 PASO 6 - ESQUEMA VACUNACIÓN INICIALIZADO');

    // Función de validación para este paso
    function validateEsquemaVacunacion() {
        let isValid = true;
        let errors = [];

        // Validar que al menos hay una vacuna registrada
        const tablaVacunas = document.getElementById('tablaVacunas');
        if (tablaVacunas) {
            const filasVacunas = tablaVacunas.children.length;
            if (filasVacunas === 0) {
                isValid = false;
                errors.push('Debe registrar al menos una vacuna');
            }
        }

        // Mostrar errores si los hay
        if (!isValid) {
            alert('Por favor complete los siguientes campos:\n\n' + errors.join('\n'));
        }

        return isValid;
    }

    // Exponer la función globalmente para el validador de pasos
    window.validateEsquemaVacunacion = validateEsquemaVacunacion;
</script>