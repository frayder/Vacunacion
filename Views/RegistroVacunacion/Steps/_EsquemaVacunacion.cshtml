@model RegistroVacunacionItemViewModel

<div class="card border-0">
    <div class="card-header bg-primary text-white">
        <div class="d-flex align-items-center">
            <i class="ri-shield-check-line me-2"></i>
            <h5 class="mb-0">Esquema de Vacunación</h5>
        </div>
    </div>
    <div class="card-body">


        <!-- Tipo de carnét -->
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label class="form-label">Tipo de carnét</label>
                    <select class="form-select" name="TipoCarnetId" id="tipoCarnet">
                        <option value="">Seleccione tipo de carnét</option>
                        <!-- Las opciones se cargarán dinámicamente desde la base de datos -->
                    </select>
                    <div id="tipoCarnetLoading" class="text-muted small mt-1" style="display: none;">
                        <i class="ri-loader-2-line"></i> Cargando tipos de carnet...
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Agregar Vacuna Aplicada -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="ri-add-circle-line text-primary me-2"></i>
                    <h6 class="mb-0 text-primary fw-bold">Agregar Vacuna Aplicada</h6>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Insumo</label>
                            <select class="form-select" name="Vacuna" id="VacunaSeleccionada">
                                <option value="">Seleccione Insumo...</option>
                                <!-- Opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6" id="detallesVacuna">
                        <div class="mb-3">
                            <label class="form-label">Número de dosis <span class="text-danger">*</span></label>
                            <select class="form-select" name="Dosis" required>
                                <option value="">Seleccione número de dosis</option>
                                <!-- Opciones se llenarán dinámicamente según el insumo seleccionado -->
                            </select>
                        </div>

                        <!-- Mensaje cuando no hay rangoDosis (oculto por defecto) -->
                        <div class="mb-3" id="sinRangoDosisContainer" style="display: none;">
                            <div class="alert alert-info border-0 bg-info-subtle" role="alert">
                                <div class="d-flex align-items-start">
                                    <i class="ri-information-line text-info me-2 mt-1"></i>
                                    <div class="text-info">
                                        <h6 class="alert-heading mb-1">Insumo sin rango de edad</h6>
                                        <small>Este insumo no tiene configurado un rango de edad específico, por lo que
                                            no requiere selección de dosis numerada.</small>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo oculto para mantener compatibilidad -->
                            <input type="hidden" name="Dosis" value="GENERAL">
                        </div>
                    </div>
                </div>

                <!-- Checkbox Marcar como perdida -->
                <div class="row">
                    <div class="col-12">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="MarcarComoPerdida"
                                name="MarcarComoPerdida" onchange="toggleMarcarComoPerdida()">
                            <label class="form-check-label text-warning fw-bold" for="MarcarComoPerdida">
                                <i class="ri-alert-line me-1"></i>
                                Marcar como perdida
                            </label>
                        </div>
                        <div class="alert alert-warning border-0 bg-warning-subtle mb-3" role="alert">
                            <div class="d-flex align-items-start">
                                <i class="ri-information-line text-warning me-2 mt-1"></i>
                                <div class="text-warning">
                                    <small>Al marcar como perdida, la vacuna se descontará del inventario pero no se
                                        registrará como aplicada al paciente.</small>
                                </div>
                            </div>
                            <!-- Motivo de la pérdida (oculto por defecto) -->
                            <div class="row" id="motivoPerdidaContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Motivo de la pérdida <span
                                                class="text-danger">*</span></label>
                                        <select class="form-select" name="MotivoPerdida" id="MotivoPerdida">
                                            <option value="">Seleccione el motivo de la pérdida</option>
                                            <option value="VENCIMIENTO">Vencimiento</option>
                                            <option value="RUPTURA">Ruptura del frasco</option>
                                            <option value="CADENA_FRIO">Ruptura de cadena de frío</option>
                                            <option value="CONTAMINACION">Contaminación</option>
                                            <option value="ERROR_PREPARACION">Error en la preparación</option>
                                            <option value="OTRO">Otro motivo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Información de rangos de edad (se muestra al seleccionar vacuna) -->
                <div id="informacionRangosEdad">
                    <div class="alert alert-info border-0 bg-info-subtle" role="alert">
                        <h6 class="alert-heading mb-2 text-info">
                            <i class="ri-information-line me-1"></i>
                            <span id="tituloInformacion">Información de rangos de edad para</span>
                        </h6>
                        <div id="contenidoInformacion" class="text-info">
                            <!-- El contenido se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Alerta específica de edad -->
                    <div id="alertaEdad" class="alert alert-warning border-0 bg-warning-subtle" style="display: none;"
                        role="alert">
                        <div class="d-flex align-items-start">
                            <i class="ri-alert-line text-warning me-2 mt-1"></i>
                            <div class="text-warning">
                                <div id="mensajeAlerta" class="mb-2"></div>
                                <div id="dosisRecomendada" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVO: Información de la vacuna seleccionada -->
                <div id="datosVacunaSeleccionada" class="card mt-3" style="display: none;">
                    <div class="card-header bg-light">
                        <div class="d-flex align-items-center">
                            <i class="ri-syringe-line text-primary me-2"></i>
                            <h6 class="mb-0 text-primary fw-bold">Datos de la vacuna: <span
                                    id="nombreVacunaSeleccionada">Triple Viral (SRP)</span></h6>
                            <button type="button" class="btn btn-primary btn-sm ms-auto" id="btnPrimeraDosis">
                                1ERA DOSIS
                            </button>
                        </div>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Lote de la Vacuna <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="LoteVacuna" id="loteVacuna"
                                        placeholder="Lote de la vacuna">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Lote Jeringa</label>
                                    <input type="text" class="form-control" name="LoteJeringa" id="loteJeringa"
                                        placeholder="Jeringa utilizada">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Lote Diluyente</label>
                                    <input type="text" class="form-control" name="LoteDiluyente" id="loteDiluyente"
                                        placeholder="Lote del diluyente">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Gotero</label>
                                    <input type="text" class="form-control" name="Gotero" id="gotero"
                                        placeholder="Gotero utilizado">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Lote Jeringa</label>
                                    <input type="text" class="form-control" name="LoteJeringaAdicional"
                                        id="loteJeringaAdicional" placeholder="Lote de la jeringa">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Número de frascos</label>
                                    <input type="number" class="form-control" name="NumeroFrascos" id="numeroFrascos"
                                        placeholder="Frascos utilizados">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Observaciones</label>
                                    <textarea class="form-control" name="ObservacionesVacuna" id="observacionesVacuna"
                                        rows="3" placeholder="Observaciones adicionales"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info border-0 bg-info-subtle mt-3" role="alert">
                            <div class="text-info small">
                                <strong>Rango de edad:</strong> DE 12 MESES A 5 AÑOS
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-success" id="agregarVacuna">
                                <i class="ri-add-circle-line me-1"></i> Agregar Vacuna
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // SOLUCIÓN DIRECTA CON JAVASCRIPT NATIVO - Más confiable
    function configurarEventosVacuna() {
        const vacunaSelect = document.getElementById('VacunaSeleccionada');
        const detallesVacuna = document.getElementById('detallesVacuna');

        if (vacunaSelect && detallesVacuna) {
            // Función principal para mostrar/ocultar
            function toggleDetalles() {
                const valor = vacunaSelect.value;

                if (valor && valor.trim() !== '') {
                    detallesVacuna.style.display = 'block';
                    detallesVacuna.style.visibility = 'visible';
                    detallesVacuna.classList.remove('d-none');
                    detallesVacuna.removeAttribute('hidden');
                    detallesVacuna.style.setProperty('display', 'block', 'important');

                    verificarRangoDosis();
                } else {
                    detallesVacuna.style.display = 'none';
                    detallesVacuna.style.visibility = 'hidden';
                    detallesVacuna.classList.add('d-none');
                }
            }

            function verificarRangoDosis() {
                const selectedOption = vacunaSelect.selectedOptions[0];
                const dosisSelectContainer = document.getElementById('dosisSelectContainer');
                const sinRangoDosisContainer = document.getElementById('sinRangoDosisContainer');

                if (selectedOption && dosisSelectContainer && sinRangoDosisContainer) {
                    const rangoDosis = selectedOption.getAttribute('data-rango-dosis');

                    if (rangoDosis && rangoDosis.trim() !== '') {
                        // Tiene rangoDosis: mostrar select de dosis
                        dosisSelectContainer.style.display = 'block';
                        sinRangoDosisContainer.style.display = 'none';

                        // Hacer el select requerido
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = true;
                        }

                        console.log('Vacuna con RangoDosis:', rangoDosis);
                    } else {
                        // No tiene rangoDosis: ocultar select y mostrar mensaje
                        dosisSelectContainer.style.display = 'none';
                        sinRangoDosisContainer.style.display = 'block';

                        // Quitar requerimiento del select oculto
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = false;
                            dosisSelect.value = ''; // Limpiar valor
                        }

                        console.log('Vacuna sin RangoDosis - Mostrando mensaje informativo');
                    }
                }
            }

            // Limpiar cualquier event listener previo
            vacunaSelect.onchange = null;
            vacunaSelect.oninput = null;

            // Asignar eventos múltiples
            vacunaSelect.addEventListener('change', toggleDetalles);
            vacunaSelect.addEventListener('input', toggleDetalles);
            vacunaSelect.onchange = toggleDetalles;

            // Observer como respaldo MEJORADO
            let ultimoValor = vacunaSelect.value;
            setInterval(function () {
                if (vacunaSelect.value !== ultimoValor) {
                    ultimoValor = vacunaSelect.value;
                    toggleDetalles();
                }
            }, 50);

            // Verificar estado inicial
            if (vacunaSelect.value && vacunaSelect.value.trim() !== '') {
                toggleDetalles();
            }

            // Función de prueba global
            window.probarVacunaManual = function (valor) {
                vacunaSelect.value = valor || 'BCG';
                toggleDetalles();
            };

            // NUEVA FUNCIÓN: Función para forzar la activación después de restaurar datos
            window.activarFlujoVacunaRestaurada = function () {
                if (vacunaSelect.value && vacunaSelect.value.trim() !== '') {
                    console.log('🔄 Activando flujo para vacuna restaurada:', vacunaSelect.value);
                    toggleDetalles();
                    // Disparar el evento change para que se ejecuten otros listeners
                    vacunaSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
            };
        }
    }

    // Función para toggle del motivo de pérdida
    function toggleMotivoPerdida() {
        const checkbox = document.getElementById('MarcarComoPerdida');
        const container = document.getElementById('motivoPerdidaContainer');
        const select = document.getElementById('MotivoPerdida');
        if (checkbox.checked) {
            container.style.display = 'block';
            select.required = true;
        } else {
            container.style.display = 'none';
            select.required = false;
            select.value = '';
        }
    }

    // Ejecutar inmediatamente y con múltiples estrategias
    configurarEventosVacuna();
    setTimeout(configurarEventosVacuna, 100);
    setTimeout(configurarEventosVacuna, 500);

    // Si hay jQuery disponible, usarlo también
    if (typeof $ !== 'undefined') {
        $(document).ready(function () {
            setTimeout(configurarEventosVacuna, 100);
        });
    }

    console.log('🎯 PASO 6 - ESQUEMA VACUNACIÓN INICIALIZADO');

    // Función de validación para este paso
    function validateEsquemaVacunacion() {
        let isValid = true;
        let errors = [];

        // Validar que al menos hay una vacuna registrada
        const tablaVacunas = document.getElementById('tablaVacunas');
        if (tablaVacunas) {
            const filasVacunas = tablaVacunas.children.length;
            if (filasVacunas === 0) {
                isValid = false;
                errors.push('Debe registrar al menos una vacuna');
            }
        }

        // Mostrar errores si los hay
        if (!isValid) {
            alert('Por favor complete los siguientes campos:\n\n' + errors.join('\n'));
        }

        return isValid;
    }

    // Exponer la función globalmente para el validador de pasos
    window.validateEsquemaVacunacion = validateEsquemaVacunacion;
</script>