@model RegistroVacunacionItemViewModel

<div class="card border-0">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0 text-white">
            <i class="ri-vaccine-line me-1"></i> Esquema        function mostrarOcultarDetasetInterval(function() {
         // Observer simple como respaldo
        let lastValue = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== lastValue) {
                console.log('üîç OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                mostrarOcultarDetalles();
            }
        }, 100);  if (vacunaSelect.value !== lastValue) {
                console.log('üîç OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                mostrarOcultarDetalles();
            }
        }, 100);         const valor = vacunaSelect.value;
            console.log('Verificando valor:', valor);
            
            if (valor && valor !== '') {
                // Usar la misma t√©cnica del SUPER TEST que sabemos que funciona
                detallesVacuna.style.display = 'block';
                detallesVacuna.style.visibility = 'visible';
                detallesVacuna.style.setProperty('display', 'block', 'important');
                console.log('‚úÖ Detalles mostrados');
            } else {
                detallesVacuna.style.setProperty('display', 'none', 'important');
                console.log('‚ùå Detalles ocultados');
            }
        }n
        </h6>
    </div>
    <div class="card-body">


        <!-- Tipo de carn√©t -->
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label class="form-label">Tipo de carn√©t</label>
                    <select class="form-select" name="TipoCarnetId" id="tipoCarnet">
                        <option value="">Seleccione tipo de carn√©t</option>
                        <!-- Las opciones se cargar√°n din√°micamente desde la base de datos -->
                    </select>
                    <div id="tipoCarnetLoading" class="text-muted small mt-1" style="display: none;">
                        <i class="ri-loader-2-line"></i> Cargando tipos de carnet...
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Agregar Vacuna Aplicada -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center">
                    <i class="ri-add-circle-line text-primary me-2"></i>
                    <h6 class="mb-0 text-primary fw-bold">Agregar Vacuna Aplicada</h6>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar Vacunas <span class="text-danger">*</span></label>
                            <select class="form-select" name="Vacuna" id="VacunaSeleccionada" required onchange="document.getElementById('detallesVacuna').style.display = this.value ? 'block' : 'none'">
                                <option value="">Seleccione la vacuna aplicada</option>
                                <optgroup label="Vacunas del PAI">
                                    <option value="BCG">BCG (Bacilo de Calmette y Gu√©rin)</option>
                                    <option value="HEPATITIS_B">Hepatitis B</option>
                                    <option value="PENTAVALENTE">Pentavalente (DPT + HepB + Hib)</option>
                                    <option value="POLIO_IPV">Polio IPV (Inactivada)</option>
                                    <option value="POLIO_OPV">Polio OPV (Oral)</option>
                                    <option value="ROTAVIRUS">Rotavirus</option>
                                    <option value="NEUMOCOCO">Neumococo</option>
                                    <option value="INFLUENZA">Influenza</option>
                                    <option value="SRP">SRP (Sarampi√≥n, Rub√©ola, Parotiditis)</option>
                                    <option value="VARICELA">Varicela</option>
                                    <option value="HEPATITIS_A">Hepatitis A</option>
                                    <option value="DPT">DPT (Difteria, Pertussis, T√©tanos)</option>
                                    <option value="TD">Td (T√©tanos, Difteria)</option>
                                    <option value="VPH">VPH (Virus del Papiloma Humano)</option>
                                </optgroup>
                                <optgroup label="Vacunas Especiales">
                                    <option value="COVID19_PFIZER">COVID-19 Pfizer</option>
                                    <option value="COVID19_MODERNA">COVID-19 Moderna</option>
                                    <option value="COVID19_ASTRAZENECA">COVID-19 AstraZeneca</option>
                                    <option value="COVID19_JANSSEN">COVID-19 Janssen</option>
                                    <option value="COVID19_SINOVAC">COVID-19 Sinovac</option>
                                    <option value="FIEBRE_AMARILLA">Fiebre Amarilla</option>
                                    <option value="MENINGITIS">Meningitis</option>
                                    <option value="ENCEFALITIS_JAPONESA">Encefalitis Japonesa</option>
                                </optgroup>
                                <optgroup label="Otras">
                                    <option value="OTRA">Otra vacuna</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Campos adicionales que aparecen al seleccionar una vacuna -->
                <div id="detallesVacuna" style="display: none;">
                    <div class="alert alert-info">
                        <i class="ri-information-line me-1"></i>
                        <strong>Informaci√≥n de la Vacuna:</strong> Complete los siguientes datos de la vacuna seleccionada.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">N√∫mero de dosis <span class="text-danger">*</span></label>
                                <select class="form-select" name="Dosis" required>
                                    <option value="">Seleccione...</option>
                                    <option value="1">Primera dosis</option>
                                    <option value="2">Segunda dosis</option>
                                    <option value="3">Tercera dosis</option>
                                    <option value="4">Cuarta dosis</option>
                                    <option value="REFUERZO">Refuerzo</option>
                                    <option value="UNICA">Dosis √∫nica</option>
                                </select>
                            </div>
                        </div> 
                    </div> 
                </div>
            </div>
        </div> 
    </div>
</div>

<script>
// SOLUCI√ìN DIRECTA CON JAVASCRIPT NATIVO - M√°s confiable
function configurarEventosVacuna() {
    const vacunaSelect = document.getElementById('VacunaSeleccionada');
    const detallesVacuna = document.getElementById('detallesVacuna');
    
    if (vacunaSelect && detallesVacuna) {
        // Funci√≥n principal para mostrar/ocultar
        function toggleDetalles() {
            const valor = vacunaSelect.value;
            
            if (valor && valor.trim() !== '') {
                detallesVacuna.style.display = 'block';
                detallesVacuna.style.visibility = 'visible';
                detallesVacuna.classList.remove('d-none');
                
                // Forzar el display
                detallesVacuna.removeAttribute('hidden');
                detallesVacuna.style.setProperty('display', 'block', 'important');
            } else {
                detallesVacuna.style.display = 'none';
                detallesVacuna.style.visibility = 'hidden';
                detallesVacuna.classList.add('d-none');
            }
        }
        
        // Limpiar cualquier event listener previo
        vacunaSelect.onchange = null;
        vacunaSelect.oninput = null;
        
        // Asignar eventos m√∫ltiples
        vacunaSelect.addEventListener('change', toggleDetalles);
        vacunaSelect.addEventListener('input', toggleDetalles);
        vacunaSelect.onchange = toggleDetalles;
        
        // Observer como respaldo MEJORADO
        let ultimoValor = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== ultimoValor) {
                ultimoValor = vacunaSelect.value;
                toggleDetalles();
            }
        }, 50); // M√°s frecuente
        
        // Verificar estado inicial
        if (vacunaSelect.value && vacunaSelect.value.trim() !== '') {
            toggleDetalles();
        }
        
        // Funci√≥n de prueba global
        window.probarVacunaManual = function(valor) {
            vacunaSelect.value = valor || 'BCG';
            toggleDetalles();
        };
        
    } else {
        // Buscar por otros selectores como respaldo
        const alternativo1 = document.querySelector('select[name="VacunaSeleccionada"]');
        const alternativo2 = document.querySelector('#detallesVacuna');
    }
}

// Ejecutar inmediatamente y con m√∫ltiples estrategias
configurarEventosVacuna();

// Ejecutar despu√©s de un delay
setTimeout(configurarEventosVacuna, 100);
setTimeout(configurarEventosVacuna, 500);

// Si hay jQuery disponible, usarlo tambi√©n
if (typeof $ !== 'undefined') {
    $(document).ready(function() {
        console.log('üîÑ RESPALDO JQUERY - Configurando...');
        setTimeout(configurarEventosVacuna, 100);
    });
}

// RESPALDO: Funci√≥n que inicializa los event listeners (JavaScript nativo)
function inicializarEventListenersNativo() {
    console.log('üîÑ RESPALDO - Inicializando con JavaScript nativo...');
    
    const vacunaSelect = document.getElementById('VacunaSeleccionada');
    const detallesVacuna = document.getElementById('detallesVacuna');
    
    console.log('üìã Elementos encontrados:');
    console.log('  - vacunaSelect:', vacunaSelect);
    console.log('  - detallesVacuna:', detallesVacuna);
    if (vacunaSelect && detallesVacuna) {
        console.log('‚úÖ ELEMENTOS ENCONTRADOS (Nativo) - Configurando event listeners...');
        console.log('  - vacunaSelect.id:', vacunaSelect.id);
        console.log('  - detallesVacuna.id:', detallesVacuna.id);
        
        // Funci√≥n para mostrar/ocultar detalles (ahora global)
        window.toggleDetallesVacuna = function() {
            const select = document.getElementById('VacunaSeleccionada');
            const detalles = document.getElementById('detallesVacuna');
            
            if (!select || !detalles) {
                console.error('No se encontraron los elementos necesarios');
                return;
            }
            
            const valor = select.value;
            console.log('Vacuna seleccionada:', valor);
            
            if (valor && valor !== '') {
                detalles.style.setProperty('display', 'block', 'important');
                detalles.style.setProperty('visibility', 'visible', 'important');
                console.log('Mostrando detalles de vacuna');
            } else {
                detalles.style.setProperty('display', 'none', 'important');
                console.log('Ocultando detalles de vacuna');
            }
        };
        
        // Event listener S√öPER SIMPLE
        function handleVacunaChange() {
            console.log('ÔøΩ EVENTO DISPARADO - Valor actual:', vacunaSelect.value);
            
            if (vacunaSelect.value) {
                console.log('‚úÖ Hay valor, mostrando detalles...');
                detallesVacuna.style.display = 'block';
            } else {
                console.log('‚ùå No hay valor, ocultando detalles...');
                detallesVacuna.style.display = 'none';
            }
            
            console.log('üìä Display final:', detallesVacuna.style.display);
        }
        
        // Funci√≥n principal para mostrar/ocultar detalles
        function mostrarOcultarDetalles() {
            const valor = vacunaSelect.value;
            console.log('üîç mostrarOcultarDetalles - Valor:', valor);
            
            if (valor && valor !== '') {
                console.log('‚úÖ MOSTRANDO detalles');
                detallesVacuna.style.display = 'block';
                detallesVacuna.classList.remove('d-none');
            } else {
                console.log('‚ùå OCULTANDO detalles');
                detallesVacuna.style.display = 'none';
                detallesVacuna.classList.add('d-none');
            }
        }
        
        // Event listeners m√∫ltiples
        console.log('üîß Asignando event listeners...');
        
        vacunaSelect.onchange = function() {
            console.log('üéØ ONCHANGE DISPARADO - Valor:', this.value);
            mostrarOcultarDetalles();
        };
        
        vacunaSelect.addEventListener('change', function() {
            console.log('üéØ ADDEVENTLISTENER CHANGE - Valor:', this.value);
            mostrarOcultarDetalles();
        });
        
        vacunaSelect.addEventListener('input', function() {
            console.log('üéØ ADDEVENTLISTENER INPUT - Valor:', this.value);
            mostrarOcultarDetalles();
        });
        
        // Observer simple como respaldo
        let lastValue = vacunaSelect.value;
        setInterval(function() {
            if (vacunaSelect.value !== lastValue) {
                console.log('ÔøΩ OBSERVER DETECT√ì CAMBIO:', lastValue, '‚Üí', vacunaSelect.value);
                lastValue = vacunaSelect.value;
                handleVacunaChange();
            }
        }, 200);
        
        // Verificar estado inicial
        if (vacunaSelect.value) {
            detallesVacuna.style.setProperty('display', 'block', 'important');
            console.log('Vacuna preseleccionada, mostrando detalles');
        }
        
    } else {
        console.error('‚ùå No se encontraron los elementos necesarios:', {
            vacunaSelect: !!vacunaSelect,
            detallesVacuna: !!detallesVacuna,
            vacunaSelectId: vacunaSelect ? vacunaSelect.id : 'null',
            detallesVacunaId: detallesVacuna ? detallesVacuna.id : 'null'
        });
    }
    
    // Verificar elementos del DOM
    console.log('Elementos DOM cargados correctamente');
    
    // Funci√≥n global para testing manual
    window.testVacunaToggle = function() {
        const detalles = document.getElementById('detallesVacuna');
        const currentDisplay = window.getComputedStyle(detalles).display;
        console.log('Display actual:', currentDisplay);
        
        if (currentDisplay === 'none') {
            detalles.style.setProperty('display', 'block', 'important');
            alert('Intentando mostrar detalles');
        } else {
            detalles.style.setProperty('display', 'none', 'important');
            alert('Intentando ocultar detalles');
        }
    };
    
    // Event listener adicional para el bot√≥n
    const btnAgregar = document.getElementById('btnAgregarVacuna');
    if (btnAgregar) {
        btnAgregar.addEventListener('click', function(e) {
            e.preventDefault();
            agregarVacuna();
        });
    }
}

console.log('üéØ PASO 6 - ESQUEMA VACUNACI√ìN INICIALIZADO');


// Funci√≥n de validaci√≥n para este paso
function validateEsquemaVacunacion() {
    let isValid = true;
    let errors = [];

    // Validar que al menos hay una vacuna registrada
    const tablaVacunas = document.getElementById('tablaVacunas');
    const filasVacunas = tablaVacunas.children.length;

    if (filasVacunas === 0) {
        isValid = false;
        errors.push('Debe registrar al menos una vacuna');
    }

    // Mostrar errores si los hay
    if (!isValid) {
        alert('Por favor complete los siguientes campos:\n\n' + errors.join('\n'));
    }

    return isValid;
}

// Exponer la funci√≥n globalmente para el validador de pasos
window.validateEsquemaVacunacion = validateEsquemaVacunacion;
</script>