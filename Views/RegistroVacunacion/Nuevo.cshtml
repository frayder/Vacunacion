@model RegistroVacunacionItemViewModel
@{
    ViewData["Title"] = "Nuevo Registro de Vacunación";
    Layout = "~/Views/Shared/_VerticalLayout.cshtml";
}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0 text-white">
                    <i class="ri-vaccine-line me-2"></i>Formulario por Pasos
                </h5>
                <p class="mb-0 text-white-50">Complete la información de paciente paso a paso</p>
            </div>
            <div class="card-body">
                <!-- Progress Steps -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary text-white px-3 py-2">Paso 1 de 7</span>
                    </div>

                    <!-- Step indicators -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="step-indicator active" data-step="1">
                            <div class="step-circle bg-primary text-white">1</div>
                            <span class="step-label">Datos Básicos</span>
                        </div>
                        <div class="step-indicator" data-step="2">
                            <div class="step-circle">2</div>
                            <span class="step-label">Datos Complementarios</span>
                        </div>
                        <div class="step-indicator" data-step="3">
                            <div class="step-circle">3</div>
                            <span class="step-label">Antecedentes Médicos</span>
                        </div>
                        <div class="step-indicator" data-step="4">
                            <div class="step-circle">4</div>
                            <span class="step-label">Condición Usuario</span>
                        </div>
                        <div class="step-indicator" data-step="5">
                            <div class="step-circle">5</div>
                            <span class="step-label">Médico/Cuidador</span>
                        </div>
                        <div class="step-indicator" data-step="6">
                            <div class="step-circle">6</div>
                            <span class="step-label">Esquema Vacunación</span>
                        </div>
                        <div class="step-indicator" data-step="7">
                            <div class="step-circle">7</div>
                            <span class="step-label">Responsable</span>
                        </div>
                    </div>
                </div>

                <form asp-action="Nuevo" method="post" id="vacunacionForm">
                    <!-- Hidden fields for model binding -->
                    @* <input type="hidden" asp-for="Paciente" /> *@

                    <!-- Dynamic Step Container -->
                    <div id="step-container">
                        <!-- Steps will be loaded here dynamically -->
                        <partial name="Steps/_DatosBasicos" model="Model" />
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                            <i class="ri-arrow-left-line me-1"></i> Anterior
                        </button>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-primary" id="nextBtn">
                                Siguiente <i class="ri-arrow-right-line ms-1"></i>
                            </button>
                            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                <i class="ri-save-line me-1"></i> Guardar Registro
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .step-indicator {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            background-color: #f8f9fa;
            color: #6c757d;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step-indicator.active .step-circle {
            background-color: #5d87ff;
            border-color: #5d87ff;
            color: white;
        }

        .step-indicator.completed .step-circle {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* Estilos para antecedentes médicos */
        .form-label .text-danger {
            font-weight: bold;
        }

        #listaAntecedentes {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        #listaAntecedentes .table td {
            vertical-align: middle;
        }

        #listaAntecedentes .btn-danger {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .form-control:invalid {
            border-color: #dc3545;
        }

        .form-control:valid {
            border-color: #28a745;
        }

        .step-label {
            font-size: 12px;
            color: #6c757d;
            display: block;
        }

        .step-indicator.active .step-label {
            color: #5d87ff;
            font-weight: 600;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .step-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            left: 50%;
            height: 2px;
            background-color: #dee2e6;
            z-index: -1;
        }

        .step-indicator.completed:not(:last-child)::after {
            background-color: #28a745;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #5d87ff;
            box-shadow: 0 0 0 0.2rem rgba(93, 135, 255, 0.25);
        }

        .text-danger.small {
            font-size: 11px;
            margin-top: 2px;
        }

        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .validation-message {
            margin-top: 2px;
        }

        .card.bg-light {
            border: 1px solid #dee2e6;
        }

        .table-sm td,
        .table-sm th {
            padding: 0.25rem;
            font-size: 0.875rem;
        }

        .btn-outline-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

        .spinner {
            animation: spin 1s linear infinite;
            -webkit-animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @@-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }
    </style>
}

@section Scripts {
    <script type="text/javascript">
        // Variables globales
        let currentStep = 1;
        const totalSteps = 7;
        let formData = {}; // Objeto para almacenar los datos del formulario

        // Función para verificar que todo está funcionando

        // Asegurarse de que el script se ejecuta después de que el DOM está listo
        document.addEventListener('DOMContentLoaded', async function () {
            try {

                // NUEVO: Limpiar datos al iniciar un nuevo registro
                for (let step = 1; step <= totalSteps; step++) {
                    localStorage.removeItem(`stepData_${step}`);
                }
                localStorage.removeItem('vacunacionFormData');
                formData = {}; // También limpiar la variable en memoria

                // Cargar datos guardados
                loadStoredData();

                // Configurar el botón siguiente
                const nextBtn = document.getElementById('nextBtn');
                const prevBtn = document.getElementById('prevBtn');

                if (nextBtn) {
                    nextBtn.addEventListener('click', async function (e) {
                        e.preventDefault();
                        try {
                            await nextStep();
                        } catch (error) {
                            console.error('Error al ejecutar nextStep:', error);
                            alert('Error: ' + error.message);
                        }
                    });
                } else {
                    console.warn('No se encontró el botón siguiente en el DOM');
                }

                if (prevBtn) {
                    prevBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        prevStep();
                    });
                }

                // Inicializar otros componentes si es necesario
                updateButtons();
                updateStepIndicators();
            } catch (error) {
                console.error('Error durante la inicialización:', error);
            }
            function loadStoredData() {
                const stored = localStorage.getItem('vacunacionFormData');
                if (stored) {
                    try {
                        formData = JSON.parse(stored);
                    } catch (e) {
                        formData = {};
                    }
                }
            }

            // Función para guardar los datos del paso actual
            function saveCurrentStepData() {
                const stepContainer = document.getElementById('step-container');
                if (!stepContainer) return;

                const currentStepData = {};
                const inputs = stepContainer.querySelectorAll('input, select, textarea');

                inputs.forEach(input => {
                    const key = input.name || input.id;
                    if (key) {
                        if (input.type === 'radio') {
                            // Para radios, solo guardar si está checked
                            if (input.checked) {
                                currentStepData[key] = input.value;
                                formData[key] = input.value;
                            }
                        } else if (input.type === 'checkbox') {
                            // Para checkboxes, SIEMPRE guardar el estado (true/false)
                            currentStepData[key] = input.checked;
                            formData[key] = input.checked;
                        } else if (input.value && input.value.trim() !== '') {
                            currentStepData[key] = input.value;
                            formData[key] = input.value; // También actualizar formData global
                        }
                    }
                });

                // Guardar datos del paso actual
                localStorage.setItem(`stepData_${currentStep}`, JSON.stringify(currentStepData));

                // Guardar formData global actualizado
                localStorage.setItem('vacunacionFormData', JSON.stringify(formData));

                // Datos guardados exitosamente
            }

            // Función para restaurar los datos del paso actual
            function restoreCurrentStepData() {
                const stepContainer = document.getElementById('step-container');
                if (!stepContainer) return;

                // Cargar datos del paso específico
                const stepDataStr = localStorage.getItem(`stepData_${currentStep}`);
                let stepData = {};

                if (stepDataStr) {
                    try {
                        stepData = JSON.parse(stepDataStr);
                    } catch (e) {
                    }
                }

                const inputs = stepContainer.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const key = input.name || input.id;

                    // Usar primero datos del paso específico, luego formData global
                    let value = stepData[key] !== undefined ? stepData[key] : formData[key];

                    if (input.type === 'checkbox') {
                        // Para checkboxes, restaurar el estado booleano explícitamente
                        if (value !== undefined && value !== null) {
                            input.checked = Boolean(value);

                            // Si es el checkbox MarcarComoPerdida, activar su lógica
                            if (input.id === 'MarcarComoPerdida') {
                                // Llamar a la función que maneja el toggle del contenedor de motivos
                                const container = document.getElementById('motivoPerdidaContainer');
                                const select = document.getElementById('MotivoPerdida');
                                if (container && select) {
                                    if (input.checked) {
                                        container.style.display = 'block';
                                        select.required = true;
                                    } else {
                                        container.style.display = 'none';
                                        select.required = false;
                                        select.value = '';
                                    }
                                }
                            }
                        }
                    } else if (input.type === 'radio') {
                        // Para radios, verificar si el valor coincide
                        if (value !== undefined && value !== null && value !== '') {
                            const isVisible = input.offsetParent !== null;
                            if (input.value === value && isVisible) {
                                input.checked = true;
                            }
                        }
                    } else {
                        // Para otros tipos de input
                        if (value !== undefined && value !== null && value !== '') {
                            input.value = value;

                            @* agrgar valor a dosis if (input.name === 'Dosis') {
                                console.log('🔄 Restaurando valor de Dosis:', value);

                                // Verificar si el select está visible o si debería estar visible
                                const dosisSelectContainer = input.closest('.mb-3');
                                const sinRangoDosisContainer = document.getElementById('sinRangoDosisContainer');

                                // Si el valor es "GENERAL", probablemente es una vacuna sin rango de dosis
                                if (value === "GENERAL") {
                                    if (dosisSelectContainer) dosisSelectContainer.style.display = 'none';
                                    if (sinRangoDosisContainer) sinRangoDosisContainer.style.display = 'block';
                                } else {
                                    // Es una dosis específica, asegurar que el select esté visible
                                    if (dosisSelectContainer) dosisSelectContainer.style.display = 'block';
                                    if (sinRangoDosisContainer) sinRangoDosisContainer.style.display = 'none';

                                    // Intentar establecer el valor con un pequeño delay para asegurar que las opciones estén cargadas
                                    setTimeout(() => {
                                        const dosisSelect = document.querySelector('select[name="Dosis"]');
                                        if (dosisSelect && dosisSelect.querySelector(`option[value="${value}"]`)) {
                                            dosisSelect.value = value;
                                            console.log('✅ Valor de Dosis restaurado correctamente:', value);
                                        } else {
                                            console.warn('⚠️ No se pudo restaurar el valor de Dosis. Opción no encontrada:', value);
                                        }
                                    }, 100);
                                }
                            } *@
                                }
                    }
                });

                 if (currentStep === 1) {
                    setTimeout(() => {
                        configurarCalculoEdad();
                    }, 50);
                }
            }

            // Función para ejecutar lógica específica de cada paso
            function executeStepSpecificLogic() {
                // Ejecutar función específica del paso si existe
                if (window.loadStepData && window.loadStepData[`step${currentStep}`]) {
                    try {
                        window.loadStepData[`step${currentStep}`]();
                    } catch (error) {
                        // Error silenciado intencionalmente
                    }
                }

                // AGREGAR MANEJO ESPECÍFICO PARA EL PASO 1
                if (currentStep === 1) {
                    // Para el paso 1, solo restaurar los datos después de un breve delay
                    setTimeout(() => {
                        restoreCurrentStepData();
                        // NUEVO: Configurar el cálculo de edad automático
                        configurarCalculoEdad();
                    }, 100);
                    return;
                }

                // Cargar datos específicos para el paso 2 (Datos Complementarios)
                if (currentStep === 2) {
                    loadDatosComplementarios().then(() => {
                        // Restaurar datos después de cargar las opciones
                        setTimeout(() => {
                            restoreCurrentStepData();
                        }, 100);
                    });
                    return;
                }

                // Inicializar lógica específica para el paso 3 (Antecedentes Médicos)
                if (currentStep === 3) {
                    setTimeout(() => {
                        initializeAntecedentesLogic();
                        restoreAntecedentes();
                        // AGREGAR ESTA LÍNEA FALTANTE:
                        restoreCurrentStepData();
                    }, 100);
                    return;
                }

                // Cargar datos específicos para el paso 4 (Condición Usuario/a)
                if (currentStep === 4) {
                    loadCondicionesUsuarias().then(() => {
                        // Restaurar datos después de cargar las opciones
                        setTimeout(() => {
                            restoreCurrentStepData();
                        }, 100);
                    });
                    return;
                }

                // Cargar datos específicos para el paso 5 (Médico/Cuidador)
                if (currentStep === 5) {
                    loadDatosMedicoCuidador().then(() => {
                        // Restaurar datos después de cargar las opciones
                        setTimeout(() => {
                            restoreCurrentStepData();
                        }, 100);
                    });
                    return;
                }

                // Cargar datos específicos para el paso 6 (Esquema Vacunación)
                if (currentStep === 6) {
                    ListarDatosEsquemaVacunacion().then(() => {
                        // Restaurar datos después de cargar las opciones
                        setTimeout(() => {
                            restoreCurrentStepData();
                            setTimeout(() => {
                                activarFlujoVacunaRestaurada();
                            }, 200);
                        }, 100);
                    });
                    return;
                }

                // Cargar datos específicos para el paso 7 (Responsable)
                if (currentStep === 7) {
                    loadControlResponsable().then(() => {
                        // Restaurar datos después de cargar las opciones
                        setTimeout(() => {
                            restoreCurrentStepData();
                        }, 100);
                    });
                    return;
                }
            }

            async function ListarDatosEsquemaVacunacion() {
                try {
                    await loadTiposCarnet();
                    await listarInsumos();

                } catch (error) {
                    // Error silenciado intencionalmente
                }
            }

            function verificarRangoDosis() {
                const vacunaSelect = document.querySelector('select[name="Vacuna"]') || document.getElementById('VacunaSeleccionada');
                if (!vacunaSelect) {
                    console.warn('Select de vacuna no encontrado para verificarRangoDosis');
                    return;
                }

                const selectedOption = vacunaSelect.selectedOptions[0];
                const dosisSelectContainer = document.getElementById('dosisSelectContainer');
                const sinRangoDosisContainer = document.getElementById('sinRangoDosisContainer');

                if (selectedOption && dosisSelectContainer && sinRangoDosisContainer) {
                    const rangoDosis = selectedOption.getAttribute('data-rango-dosis');

                    if (rangoDosis && rangoDosis.trim() !== 'sin configuraciones') {
                        // Tiene rangoDosis: mostrar select de dosis
                        dosisSelectContainer.style.display = 'block';
                        sinRangoDosisContainer.style.display = 'none';

                        // Hacer el select requerido
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = true;
                        }
                    } else {
                        // No tiene rangoDosis: ocultar select y mostrar mensaje
                        dosisSelectContainer.style.display = 'none';
                        sinRangoDosisContainer.style.display = 'block';

                        // Quitar requerimiento del select oculto
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = false;
                            dosisSelect.value = ''; // Limpiar valor
                        }
                    }
                }
            }

            function verificarRangoDosis() {
                const vacunaSelect = document.querySelector('select[name="Vacuna"]') || document.getElementById('VacunaSeleccionada');
                if (!vacunaSelect) {
                    console.warn('Select de vacuna no encontrado para verificarRangoDosis');
                    return;
                }

                const selectedOption = vacunaSelect.selectedOptions[0];
                const dosisSelectContainer = document.getElementById('dosisSelectContainer');
                const sinRangoDosisContainer = document.getElementById('sinRangoDosisContainer');

                if (selectedOption && dosisSelectContainer && sinRangoDosisContainer) {
                    const rangoDosis = selectedOption.getAttribute('data-rango-dosis');

                    if (rangoDosis && rangoDosis.trim() !== 'sin configuraciones') {
                        // Tiene rangoDosis: mostrar select de dosis
                        dosisSelectContainer.style.display = 'block';
                        sinRangoDosisContainer.style.display = 'none';

                        // Hacer el select requerido
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = true;
                        }
                    } else {
                        // No tiene rangoDosis: ocultar select y mostrar mensaje
                        dosisSelectContainer.style.display = 'none';
                        sinRangoDosisContainer.style.display = 'block';

                        // Quitar requerimiento del select oculto
                        const dosisSelect = dosisSelectContainer.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            dosisSelect.required = false;
                            dosisSelect.value = ''; // Limpiar valor
                        }
                    }
                }
            }

            // AGREGAR: Función para activar el flujo cuando se restauran datos del paso 6
            function activarFlujoVacunaRestaurada() {
                const vacunaSelect = document.querySelector('select[name="Vacuna"]') || document.getElementById('VacunaSeleccionada');
                const detallesVacuna = document.getElementById('detallesVacuna');

                if (!vacunaSelect || !vacunaSelect.value || vacunaSelect.value.trim() === '') {
                    return;
                }

                // Mostrar los detalles de vacuna
                if (detallesVacuna) {
                    detallesVacuna.style.display = 'block';
                    detallesVacuna.style.visibility = 'visible';
                    detallesVacuna.classList.remove('d-none');
                    detallesVacuna.removeAttribute('hidden');
                    detallesVacuna.style.setProperty('display', 'block', 'important');
                }

                // Verificar y configurar el rango de dosis
                verificarRangoDosis();

                // Disparar el evento change para ejecutar toda la lógica del select de vacunas
                const selectedOption = vacunaSelect.selectedOptions[0];
                if (selectedOption) {
                    const vacunaId = vacunaSelect.value;
                    const tituloInformacion = document.getElementById('tituloInformacion');

                    // Actualizar título de información
                    if (tituloInformacion) {
                        tituloInformacion.textContent = `Información de rangos de edad para ${selectedOption.textContent || ''}`;
                    }

                    // Obtener configuraciones de rango
                    const rangoDosis = selectedOption.getAttribute('data-rango-dosis');
                    let rangoDosisArray = [];
                    try {
                        const rangoDosisArrayAttr = selectedOption.getAttribute('data-rango-dosis-array');
                        rangoDosisArray = rangoDosisArrayAttr ? JSON.parse(rangoDosisArrayAttr) : [];
                    } catch (e) {
                        console.warn('Error al parsear rangoDosisArray:', e);
                    }

                    // Ejecutar la lógica de rangos si hay configuraciones
                    if (rangoDosis && rangoDosis.trim() !== 'Sin configuraciones') {
                        listarInsumosDosis(vacunaId);
                    } else {
                        limpiarSelectDosis();
                    }

                    // Calcular edad y mostrar información de rangos
                    const fechaNac = formData.FechaNacimiento;
                    const edad = fechaNac ? calcularEdad(new Date(fechaNac)) : null;

                    // Ejecutar funciones de renderizado si están disponibles
                    if (typeof renderRangos === 'function' && typeof mostrarAlertaSegunRangos === 'function') {
                        const resultado = renderRangos(rangoDosisArray, edad);
                        mostrarAlertaSegunRangos(resultado, rangoDosisArray);
                    }
                }
                toggleMarcarComoPerdida();
            }

            // Devuelve { years, months, days, totalMonths, totalDays }
            function calcularEdad(fechaNacimiento, referencia = new Date()) {
                if (!fechaNacimiento) return null;
                const birth = new Date(fechaNacimiento.getFullYear(), fechaNacimiento.getMonth(), fechaNacimiento.getDate());
                const ref = new Date(referencia.getFullYear(), referencia.getMonth(), referencia.getDate());

                let years = ref.getFullYear() - birth.getFullYear();
                let months = ref.getMonth() - birth.getMonth();
                let days = ref.getDate() - birth.getDate();

                if (days < 0) {
                    months--;
                    // calcular días previos (simple ajuste)
                    const prevMonth = new Date(ref.getFullYear(), ref.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }

                const totalMonths = years * 12 + months;
                const totalDays = Math.floor((ref - birth) / (1000 * 60 * 60 * 24));

                return { years, months, days, totalMonths, totalDays };
            }

            // Renderiza la lista de rangos y devuelve los que aplican
            function renderRangos(rangos, edad) {
                contenidoInformacion.innerHTML = ''; // limpiar
                alertaEdad.style.display = 'none';
                mensajeAlerta.textContent = '';
                dosisRecomendada.textContent = '';

                const ageEl = document.createElement('div');
                ageEl.className = 'mb-2';
                if (edad) {
                    ageEl.innerHTML = `<strong>Edad del paciente:</strong> ${edad.years} años, ${edad.totalMonths} meses (${edad.totalDays} días aprox.)`;
                } else {
                    ageEl.innerHTML = `<small class="text-danger">No se ha calculado la edad del paciente. Verifique que se haya ingresado la fecha de nacimiento en el paso de Datos Básicos.</small>`;
                    contenidoInformacion.appendChild(ageEl);
                }
                contenidoInformacion.appendChild(ageEl);

                if (!rangos || !Array.isArray(rangos) || rangos.length === 0) {
                    const noData = document.createElement('div');
                    noData.className = 'small text-muted';
                    noData.textContent = 'No se encontraron rangos de edad para esta vacuna.';
                    contenidoInformacion.appendChild(noData);
                    return { aplican: [], noAplican: [] };
                }

                const list = document.createElement('div');
                list.className = 'list-group';

                const aplican = [];
                const noAplican = [];

                rangos.forEach((r) => {
                    // r espera: texto, textoRango, minMonths, maxMonths, dosis (opcional)
                    const aplica = edad ? rangoAplica(r, edad.totalDays) : false;
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    const left = document.createElement('div');
                    left.innerHTML = `<div class="fw-bold">${r.dosis || 'Rango'}: ${r.descripcionRango || ''}</div>`;
                    const badge = document.createElement('span');

                    if (aplica) {
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Aplica';
                        aplican.push(r);
                    } else {
                        badge.className = 'badge bg-secondary';
                        badge.textContent = 'No aplica';
                        noAplican.push(r);
                    }

                    item.appendChild(left);
                    item.appendChild(badge);
                    list.appendChild(item);
                });

                contenidoInformacion.appendChild(list);
                return { aplican, noAplican };
            }

            function toggleMarcarComoPerdida() {
                const checkbox = document.getElementById('MarcarComoPerdida');
                const container = document.getElementById('motivoPerdidaContainer');
                const select = document.getElementById('MotivoPerdida');
                const dosisSelect = document.querySelector('select[name="Dosis"]');
                const vacunaSelect = document.getElementById('VacunaSeleccionada');

                if (checkbox.checked) {
                    // Mostrar motivo de pérdida
                    container.style.display = 'block';
                    select.required = true;

                    // Llenar el select de dosis con data-rango-dosis-array si la vacuna está seleccionada
                    if (vacunaSelect && vacunaSelect.value && dosisSelect) {
                        const selectedOption = vacunaSelect.selectedOptions[0];
                        if (selectedOption) {
                            const rangoDosisArrayAttr = selectedOption.getAttribute('data-rango-dosis-array');

                            if (rangoDosisArrayAttr) {
                                try {
                                    const rangoDosisArray = JSON.parse(rangoDosisArrayAttr);

                                    // Limpiar opciones actuales
                                    dosisSelect.innerHTML = '<option value="">Seleccione dosis...</option>';

                                    // Agregar opciones del data-rango-dosis-array
                                    rangoDosisArray.forEach(rango => {
                                        if (rango.dosis) {
                                            const option = document.createElement('option');
                                            option.value = rango.dosis;
                                            option.textContent = rango.dosis + (rango.descripcionRango ? ` - ${rango.descripcionRango}` + ' (Fuera de edad)' : '');
                                            dosisSelect.appendChild(option);
                                        }
                                    });
                                } catch (e) {
                                    console.warn('Error al parsear data-rango-dosis-array:', e);
                                }
                            }
                        }
                    }
                }
            }

            // Determina si la edad (en meses) cae dentro del rango.
            // minMonths y maxMonths son inclusive si definidos. Si faltan, se asume abierto.
            function rangoAplica(rango, edadDays) {
                if (!rango || typeof edadDays !== 'number') return false;

                // Función auxiliar para convertir edad a días según la unidad
                function convertirADias(valor, unidad) {
                    if (!valor || !unidad) return null;

                    switch (unidad.toLowerCase()) {
                        case 'Días':
                        case 'días':
                        case 'Dias':
                        case 'dias':
                        case 'day':
                        case 'days':
                            return valor;
                        case 'Meses':
                        case 'meses':
                        case 'months':
                        case 'month':
                            return valor * 30.44; // Promedio de días por mes
                        case 'Anos':
                        case 'anos':
                        case 'Años':
                        case 'años':
                        case 'years':
                        case 'year':
                            return valor * 365.25; // Considerando años bisiestos
                        default:
                            console.warn('Unidad de medida no reconocida:', unidad);
                            return null;
                    }
                }

                // Convertir edad mínima a días
                let minDays = -Infinity;
                if (rango.edadMinima !== undefined && rango.edadMinima !== null) {
                    const convertedMin = convertirADias(rango.edadMinima, rango.unidadMedidaEdadMinima);
                    if (convertedMin !== null) {
                        minDays = convertedMin;
                    }
                }

                // Convertir edad máxima a días
                let maxDays = Infinity;
                if (rango.edadMaxima !== undefined && rango.edadMaxima !== null) {
                    const convertedMax = convertirADias(rango.edadMaxima, rango.unidadMedidaEdadMaxima);
                    if (convertedMax !== null) {
                        maxDays = convertedMax;
                    }
                }

                // Verificar si la edad está dentro del rango
                const resultado = edadDays >= minDays && edadDays <= maxDays;

                return resultado;
            }

            function mostrarAlertaSegunRangos(resultado, rangos) {
                // Decide el mensaje y tipo de alerta
                if (!resultado || (!resultado.aplican || resultado.aplican.length === 0)) {
                    alertaEdad.className = 'alert alert-danger border-0 bg-danger-subtle';
                    mensajeAlerta.textContent = 'No hay rangos de edad que apliquen para la edad del paciente.';
                    alertaEdad.style.display = 'block';
                    return;
                }
            }

            async function listarInsumos() {
                try {
                    const response = await fetch('/RegistroVacunacion/GetInsumos');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // Poblar el select "Vacuna"
                    populateSelect('Vacuna', data, 'Seleccione vacuna');

                    // Obtener el select por name (puede que exista con id distinto)
                    const vacunaSelect = document.querySelector('select[name="Vacuna"]');
                    if (!vacunaSelect) {
                        return;
                    }

                    // Si ya hay un valor seleccionado (por restoreCurrentStepData), cargar las dosis para esa vacuna
                    const currentVacuna = vacunaSelect.value;
                    if (currentVacuna) {
                        // MODIFICAR: Verificar si la vacuna tiene RangoDosis antes de cargar las dosis
                        const selectedOption = vacunaSelect.selectedOptions[0];
                        if (selectedOption && selectedOption.getAttribute('data-rango-dosis') !== 'Sin configuraciones') {
                            listarInsumosDosis(currentVacuna);
                        }
                    }

                    // Agregar listener para actualizar las dosis cuando el usuario cambie la vacuna
                    // Antes de agregar, remover cualquier listener previo (defensivo) usando cloneNode
                    const newSelect = vacunaSelect.cloneNode(true);
                    vacunaSelect.parentNode.replaceChild(newSelect, vacunaSelect);

                    newSelect.addEventListener('change', function () {
                        const vacunaId = this.value;
                        // MODIFICAR: Solo llamar listarInsumosDosis si la vacuna tiene RangoDosis
                        if (vacunaId) {
                            const selectedOption = this.selectedOptions[0];
                            tituloInformacion.textContent = `Información de rangos de edad para ${selectedOption.outerText || ''}`;
                            const rangoDosis = selectedOption ? selectedOption.getAttribute('data-rango-dosis') : null;
                            const rangoDosisArray = selectedOption ? JSON.parse(selectedOption.getAttribute('data-rango-dosis-array')) : [];

                            if (rangoDosis && rangoDosis.trim() !== 'Sin configuraciones') {
                                listarInsumosDosis(vacunaId);
                            } else {
                                limpiarSelectDosis();
                            }

                            const fechaNac = formData.FechaNacimiento;
                            const edad = fechaNac ? calcularEdad(new Date(fechaNac)) : null;

                            const resultado = renderRangos(rangoDosisArray, edad);
                            mostrarAlertaSegunRangos(resultado, rangoDosisArray);
                        } else {
                            limpiarSelectDosis();
                        }
                    });

                    const tituloInformacion = document.getElementById('tituloInformacion');
                    const contenidoInformacion = document.getElementById('contenidoInformacion');
                    const alertaEdad = document.getElementById('alertaEdad');
                    const mensajeAlerta = document.getElementById('mensajeAlerta');
                    const dosisRecomendada = document.getElementById('dosisRecomendada');

                    // AGREGAR: Nueva función para limpiar el select de dosis
                    function limpiarSelectDosis() {
                        const dosisSelect = document.querySelector('select[name="Dosis"]');
                        if (dosisSelect) {
                            // Limpiar opciones existentes excepto la primera
                            while (dosisSelect.children.length > 1) {
                                dosisSelect.removeChild(dosisSelect.lastChild);
                            }
                            // Restaurar texto por defecto
                            if (dosisSelect.children.length > 0) {
                                dosisSelect.children[0].textContent = 'Seleccione dosis';
                            }
                        }
                    }

                    // Parse flexible ISO or dd/mm/yyyy or mm/dd/yyyy (lo más robusto posible)
                    function parseDateISOOrLocal(s) {
                        if (!s) return null;
                        // If already a Date
                        if (s instanceof Date) return s;
                        // ISO-like YYYY-MM-DD
                        let iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
                        if (iso) {
                            const d = new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]));
                            if (!isNaN(d)) return d;
                        }
                        // dd/mm/yyyy or dd-mm-yyyy
                        let dmy = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
                        if (dmy) {
                            const d = new Date(Number(dmy[3]), Number(dmy[2]) - 1, Number(dmy[1]));
                            if (!isNaN(d)) return d;
                        }
                        // fallback to Date.parse
                        const pd = new Date(s);
                        if (!isNaN(pd)) return pd;
                        return null;
                    }



                    // Intentar leer rangos desde el <option data-rangos='[...]'>
                    // Formato de rango esperado:
                    function parseRangosFromOption(optionEl) {
                        if (!optionEl) return null;
                        const attr = optionEl.getAttribute('data-rangos') || optionEl.dataset.rangos;
                        if (!attr) return null;
                        try {
                            return JSON.parse(attr);
                        } catch (e) {
                            console.warn('No se pudo parsear data-rangos', e);
                            return null;
                        }
                    }

                    // Si no hay data-rangos, intentar obtener de una API REST (si existe)
                    async function fetchRangosApi(vacunaId) {
                        if (!vacunaId) return null;
                        const url = `/api/vacunas/${encodeURIComponent(vacunaId)}/rangosEdad`;
                        try {
                            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                            if (!res.ok) return null;
                            const data = await res.json();
                            return data;
                        } catch (e) {
                            console.warn('fetchRangosApi fallo', e);
                            return null;
                        }
                    }







                    // Orquestador: al cambiar la vacuna
                    async function onVacunaChange() {
                        const opt = vacunaSelect && vacunaSelect.selectedOptions && vacunaSelect.selectedOptions[0];
                        const vacunaNombre = opt ? (opt.textContent || opt.value) : '';
                        const vacunaId = opt ? (opt.value) : '';


                        // obtener fecha de nacimiento -> edad
                        const fechaNac = formData.FechaNacimiento;
                        const edad = fechaNac ? calcularEdad(fechaNac) : null;

                        // obtener rangos: primero del option, luego intentar fetch
                        let rangos = parseRangosFromOption(opt);
                        if (!rangos) {
                            rangos = await fetchRangosApi(vacunaId);
                        }

                        // render
                        const resultado = renderRangos(rangos, edad);
                        mostrarAlertaSegunRangos(resultado, rangos);
                    }


                } catch (error) {
                    // Error silenciado intencionalmente
                    console.error('Error en listarInsumos:', error);
                }
            }

            function listarInsumosDosis(vacunaId) {
                const dosisSelect = document.querySelector('select[name="Dosis"]');
                if (!dosisSelect) return;

                // Limpiar opciones existentes excepto la primera
                while (dosisSelect.children.length > 1) {
                    dosisSelect.removeChild(dosisSelect.lastChild);
                }
                if (!vacunaId) return;
                // Obtener fecha de nacimiento: preferir lo guardado en formData/localStorage, si existe
                let fechaNacimiento = null;

                try {
                    // 1) Usar la variable in-memory 'formData' si existe y tiene la propiedad
                    if (typeof formData !== 'undefined' && formData) {
                        if (formData.FechaNacimiento) fechaNacimiento = formData.FechaNacimiento;
                        else if (formData.fechaNacimiento) fechaNacimiento = formData.fechaNacimiento;
                    }
                    // 2) Intentar stepData_1 (datos guardados por paso)
                    if (!fechaNacimiento) {
                        const step1 = localStorage.getItem('stepData_1');
                        if (step1) {
                            try {
                                const parsed = JSON.parse(step1);
                                fechaNacimiento = parsed.FechaNacimiento || parsed.fechaNacimiento || fechaNacimiento;
                            } catch { /* ignore */ }
                        }
                    }
                    // 3) Intentar el objeto global 'vacunacionFormData'
                    if (!fechaNacimiento) {
                        const stored = localStorage.getItem('vacunacionFormData');
                        if (stored) {
                            try {
                                const parsed = JSON.parse(stored);
                                fechaNacimiento = parsed.FechaNacimiento || parsed.fechaNacimiento || fechaNacimiento;
                            } catch { /* ignore */ }
                        }
                    }
                    // 4) Intentar leer directamente del input (por si el paso 1 está en DOM)
                    if (!fechaNacimiento) {
                        const fechaInput = document.querySelector('input[name="FechaNacimiento"], input[id="FechaNacimiento"], input[name="fechaNacimiento"]');
                        if (fechaInput && fechaInput.value) fechaNacimiento = fechaInput.value;
                    }
                    // Normalizar formatos: convertir dd/mm/yyyy -> yyyy-mm-dd
                    if (fechaNacimiento && /^\d{2}\/\d{2}\/\d{4}$/.test(fechaNacimiento)) {
                        const parts = fechaNacimiento.split('/');
                        fechaNacimiento = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`; // yyyy-mm-dd
                    }
                    if (!fechaNacimiento) {
                        console.warn('Fecha de nacimiento no encontrada en localStorage/variables/DOM. No se filtrarán las dosis por edad.');
                        return; // o hacer fetch sin fecha si prefieres
                    }

                    const url = `/RegistroVacunacion/GetDosisByVacuna?vacunaId=${encodeURIComponent(vacunaId)}&fechaNacimiento=${encodeURIComponent(fechaNacimiento)}`;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data && !data.error && Array.isArray(data)) {
                                data.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item.value;
                                    option.textContent = item.text;
                                    dosisSelect.appendChild(option);
                                });
                            } else {
                                // Si el backend devuelve { error: ... } y quieres fallback, puedes llamar sin fecha aquí
                                if (data && data.error) {
                                    console.warn('GetDosisByVacuna error:', data.error);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar dosis:', error);
                        });

                } catch (err) {
                    console.error('Error preparando petición de dosis:', err);
                }
            }

            async function loadControlResponsable() {
                try {
                    // Cargar Centros de Atención
                    const centrosResponse = await fetch('/RegistroVacunacion/GetCentrosAtencion');
                    if (centrosResponse.ok) {
                        const centros = await centrosResponse.json();
                        populateSelect('CentroSaludResponsable', centros, 'Seleccione Centro de Salud');
                    }
                } catch (error) {
                    // Error silenciado intencionalmente
                }
            }

            // Función para cargar datos de los dropdowns del paso 2
            async function loadDatosComplementarios() {
                try {
                    // Cargar Aseguradoras
                    const aseguradorasResponse = await fetch('/RegistroVacunacion/GetAseguradoras');
                    if (aseguradorasResponse.ok) {
                        const aseguradoras = await aseguradorasResponse.json();
                        populateSelect('AseguradoraId', aseguradoras, 'Seleccione aseguradora');
                    }

                    // Cargar Regímenes de Afiliación
                    const regimenesResponse = await fetch('/RegistroVacunacion/GetRegimenesAfiliacion');
                    if (regimenesResponse.ok) {
                        const regimenes = await regimenesResponse.json();
                        populateSelect('RegimenAfiliacionId', regimenes, 'Seleccione régimen');
                    }

                    // Cargar Pertenencias Étnicas
                    const pertenenciasResponse = await fetch('/RegistroVacunacion/GetPertenenciasEtnicas');
                    if (pertenenciasResponse.ok) {
                        const pertenencias = await pertenenciasResponse.json();
                        populateSelect('PertenenciaEtnicaId', pertenencias, 'Seleccione pertenencia étnica');
                    }

                    // Cargar Centros de Atención
                    const centrosResponse = await fetch('/RegistroVacunacion/GetCentrosAtencion');
                    if (centrosResponse.ok) {
                        const centros = await centrosResponse.json();
                        populateSelect('CentroAtencionId', centros, 'Seleccione Centro de Salud');
                        populateSelect('LugardeParto', centros, 'Seleccione Lugar de Parto');
                    }

                } catch (error) {
                    // Error silenciado intencionalmente
                }
            }

            // Función para llenar un select con datos
            function populateSelect(selectName, data, defaultText) {
                const select = document.querySelector(`select[name="${selectName}"]`);
                if (select && data && !data.error && Array.isArray(data)) {
                    // Limpiar opciones existentes excepto la primera
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }

                    // Actualizar texto de la opción por defecto
                    if (select.children.length > 0) {
                        select.children[0].textContent = defaultText;
                    }

                    // Agregar nuevas opciones
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.textContent = item.text;

                        // AGREGAR: Incluir rangoDosis como data attribute si existe
                        if (selectName === 'Vacuna' && item.rangoDosis) {
                            option.setAttribute('data-rango-dosis', item.rangoDosis);
                            option.setAttribute('data-rango-dosis-array', JSON.stringify(item.configuracionesRango));
                        }

                        select.appendChild(option);
                    });
                }
            }

            // Función para limpiar los datos guardados
            function clearStoredData() {
                formData = {};
                localStorage.removeItem('vacunacionFormData');
            }

            // Hacer las funciones globalmente accesibles
            window.saveCurrentStepData = saveCurrentStepData;
            window.restoreCurrentStepData = restoreCurrentStepData;
            window.clearStoredData = clearStoredData;

            // Define functions first
            async function nextStep() {
                // Guardar los datos del paso actual
                saveCurrentStepData();

                // Validar el paso actual antes de continuar
                if (currentStep === 1) {
                    // Validar datos básicos
                    if (typeof window.validateDatosBasicos === 'function') {
                        if (!window.validateDatosBasicos()) {
                            return; // No continuar si la validación falla
                        }
                    }
                } else if (currentStep === 6) {
                    // Validar esquema de vacunación
                    if (typeof window.validateEsquemaVacunacion === 'function') {
                        if (!window.validateEsquemaVacunacion()) {
                            return; // No continuar si la validación falla
                        }
                    }
                }

                if (currentStep < totalSteps) {
                    currentStep++;

                    try {
                        const url = '/RegistroVacunacion/LoadStep?step=' + currentStep;

                        const response = await fetch(url);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const html = await response.text();

                        const stepContainer = document.getElementById('step-container');
                        if (stepContainer) {
                            stepContainer.innerHTML = html;

                            // Restaurar los datos después de cargar el nuevo contenido
                            executeStepSpecificLogic();

                            updateButtons();
                            updateStepIndicators();
                        } else {
                            console.error('Error: No se encontró el contenedor step-container');
                            alert('Error: No se encontró el contenedor para mostrar el siguiente paso');
                        }
                    } catch (error) {
                        console.error('Error al cargar el siguiente paso:', error);
                        alert('Error al cargar el paso: ' + error.message);
                    }
                }
            }

            function prevStep() {
                if (currentStep > 1) {
                    // Guardar los datos del paso actual
                    saveCurrentStepData();

                    currentStep--;

                    fetch('/RegistroVacunacion/LoadStep?step=' + currentStep)
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('step-container').innerHTML = html;

                            // Restaurar los datos después de cargar el nuevo contenido
                            executeStepSpecificLogic();

                            updateButtons();
                            updateStepIndicators();
                        });
                }
            }

            function updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const submitBtn = document.getElementById('submitBtn');

                if (prevBtn) {
                    prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-block';
                }

                if (currentStep === totalSteps) {
                    if (nextBtn) nextBtn.style.display = 'none';
                    if (submitBtn) submitBtn.style.display = 'inline-block';
                } else {
                    if (nextBtn) nextBtn.style.display = 'inline-block';
                    if (submitBtn) submitBtn.style.display = 'none';
                }
            }

            function updateStepIndicators() {
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    const stepNumber = index + 1;

                    if (stepNumber < currentStep) {
                        indicator.classList.add('completed');
                        indicator.classList.remove('active');
                    } else if (stepNumber === currentStep) {
                        indicator.classList.add('active');
                        indicator.classList.remove('completed');
                    } else {
                        indicator.classList.remove('active', 'completed');
                    }
                });

                const badge = document.querySelector('.badge');
                if (badge) {
                    badge.textContent = `Paso ${currentStep} de ${totalSteps}`;
                }
            }

            // Función para manejar antecedentes médicos
            function initializeAntecedentesLogic() {
                const agregarBtn = document.getElementById('agregarAntecedenteBtn');
                if (agregarBtn) {
                    agregarBtn.addEventListener('click', function () {
                        agregarAntecedente();
                    });
                }
            }

            function agregarAntecedente() {
                // Obtener valores del formulario
                const fecha = document.querySelector('input[name="FechaRegistroAntecedente"]')?.value;
                const tipo = document.querySelector('input[name="TipoAntecedente"]')?.value;
                const descripcion = document.querySelector('textarea[name="DescripcionAntecedente"]')?.value;
                const observaciones = document.querySelector('textarea[name="ObservacionesAntecedente"]')?.value;

                // Validar campos requeridos
                if (!fecha || !tipo || !descripcion) {
                    alert('Por favor complete todos los campos obligatorios (Fecha, Tipo y Descripción)');
                    return;
                }

                // Validar formato de fecha (para input type="date" el formato es yyyy-mm-dd)
                if (!Date.parse(fecha)) {
                    alert('Por favor seleccione una fecha válida');
                    return;
                }

                // Formatear la fecha para mostrar en formato más legible
                const fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });

                // Crear el antecedente
                const antecedente = {
                    fecha: fecha, // Guardar fecha original
                    fechaFormateada: fechaFormateada, // Fecha formateada para mostrar
                    tipo: tipo,
                    descripcion: descripcion,
                    observaciones: observaciones || 'N/A'
                };

                // Agregar a la lista
                const tableBody = document.getElementById('antecedentesTableBody');
                const listaContainer = document.getElementById('listaAntecedentes');

                if (tableBody && listaContainer) {
                    // Mostrar la tabla si está oculta
                    listaContainer.style.display = 'block';

                    // Crear fila de la tabla
                    const row = document.createElement('tr');
                    row.innerHTML = `
                                                                            <td>${antecedente.fechaFormateada}</td>
                                                                            <td>${antecedente.tipo}</td>
                                                                            <td>${antecedente.descripcion}</td>
                                                                            <td>${antecedente.observaciones}</td>
                                                                            <td>
                                                                                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAntecedente(this)">
                                                                                    <i class="ri-delete-bin-line"></i>
                                                                                </button>
                                                                            </td>
                                                                        `;

                    tableBody.appendChild(row);

                    // Limpiar el formulario
                    document.querySelector('input[name="FechaRegistroAntecedente"]').value = '';
                    document.querySelector('input[name="TipoAntecedente"]').value = '';
                    document.querySelector('textarea[name="DescripcionAntecedente"]').value = '';
                    document.querySelector('textarea[name="ObservacionesAntecedente"]').value = '';

                    // Guardar en formData
                    if (!formData.antecedentes) {
                        formData.antecedentes = [];
                    }
                    formData.antecedentes.push(antecedente);
                    localStorage.setItem('vacunacionFormData', JSON.stringify(formData));

                    // Antecedente procesado exitosamente
                }
            }

            function eliminarAntecedente(button) {
                if (confirm('¿Está seguro de que desea eliminar este antecedente?')) {
                    const row = button.closest('tr');
                    const index = Array.from(row.parentNode.children).indexOf(row);

                    // Eliminar de la tabla
                    row.remove();

                    // Eliminar de formData
                    if (formData.antecedentes && formData.antecedentes.length > index) {
                        formData.antecedentes.splice(index, 1);
                        localStorage.setItem('vacunacionFormData', JSON.stringify(formData));
                    }

                    // Ocultar la tabla si no hay más antecedentes
                    const tableBody = document.getElementById('antecedentesTableBody');
                    const listaContainer = document.getElementById('listaAntecedentes');
                    if (tableBody && tableBody.children.length === 0 && listaContainer) {
                        listaContainer.style.display = 'none';
                    }
                }
            }

            // Función para restaurar antecedentes guardados
            function restoreAntecedentes() {
                if (formData.antecedentes && formData.antecedentes.length > 0) {
                    const tableBody = document.getElementById('antecedentesTableBody');
                    const listaContainer = document.getElementById('listaAntecedentes');

                    if (tableBody && listaContainer) {
                        // Limpiar tabla existente
                        tableBody.innerHTML = '';

                        // Mostrar la tabla
                        listaContainer.style.display = 'block';

                        // Agregar cada antecedente
                        formData.antecedentes.forEach(antecedente => {
                            // Si no tiene fechaFormateada (datos anteriores), formatearla
                            const fechaMostrar = antecedente.fechaFormateada ||
                                new Date(antecedente.fecha).toLocaleDateString('es-ES', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                });

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                                                                    <td>${fechaMostrar}</td>
                                                                                    <td>${antecedente.tipo}</td>
                                                                                    <td>${antecedente.descripcion}</td>
                                                                                    <td>${antecedente.observaciones}</td>
                                                                                    <td>
                                                                                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarAntecedente(this)">
                                                                                            <i class="ri-delete-bin-line"></i>
                                                                                        </button>
                                                                                    </td>
                                                                                `;
                            tableBody.appendChild(row);
                        });
                    }
                }
            }

            // Función para cargar condiciones usuarias en el paso 4
            async function loadCondicionesUsuarias() {
                fetch('@Url.Action("GetCondicionesUsuarias", "RegistroVacunacion")')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {

                        const select = document.getElementById('condicionUsuariaSelect');
                        if (!select) {
                            return;
                        }

                        const currentValue = select.value; // Preservar valor actual

                        if (data.error) {
                            return;
                        }

                        // Limpiar opciones existentes (excepto la primera)
                        select.innerHTML = '<option value="">Seleccionar...</option>';

                        // Agregar las opciones de condiciones usuarias
                        if (Array.isArray(data) && data.length > 0) {
                            data.forEach(condicion => {
                                const option = document.createElement('option');
                                option.value = condicion.value;
                                option.textContent = condicion.text;

                                // Mantener la selección si existía
                                if (condicion.value == currentValue) {
                                    option.selected = true;
                                }

                                select.appendChild(option);
                            });
                            // Options added successfully
                        }
                    })
                    .catch(error => {
                        // Error handled silently
                    });
            }

            // Función para cargar datos de médico/cuidador en el paso 5
            async function loadDatosMedicoCuidador() {
                try {
                    // Cargar Regímenes de Afiliación para la madre
                    const regimenesResponse = await fetch('/RegistroVacunacion/GetRegimenesAfiliacion');
                    if (regimenesResponse.ok) {
                        const regimenes = await regimenesResponse.json();
                        populateSelectById('RegimenCuidador', regimenes, 'Seleccione régimen');
                    }

                    // Cargar Pertenencias Étnicas para la madre y cuidador
                    const pertenenciasResponse = await fetch('/RegistroVacunacion/GetPertenenciasEtnicas');
                    if (pertenenciasResponse.ok) {
                        const pertenencias = await pertenenciasResponse.json();
                        populateSelectById('EtniaCuidador', pertenencias, 'Seleccione pertenencia étnica');
                    }
                } catch (error) {
                    console.error('Error al cargar datos de médico/cuidador:', error);
                }
            }

            // Función para llenar un select por ID con datos
            function populateSelectById(selectId, data, defaultText) {
                const select = document.getElementById(selectId);
                if (select && data && !data.error && Array.isArray(data)) {
                    // Preservar valor actual
                    const currentValue = select.value;

                    // Limpiar opciones existentes excepto la primera
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }

                    // Actualizar texto de la opción por defecto
                    if (select.children.length > 0) {
                        select.children[0].textContent = defaultText;
                    }

                    // Agregar nuevas opciones
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.textContent = item.text;

                        // Mantener la selección si existía
                        if (item.value == currentValue) {
                            option.selected = true;
                        }

                        select.appendChild(option);
                    });

                    // Select populated successfully
                } else if (data && data.error) {
                    // Error handled silently
                }
            }

            window.verificarRangoDosis = verificarRangoDosis;


            // Función para cargar tipos de carnet en el paso 6
            async function loadTiposCarnet() {
                try {
                    const response = await fetch('/RegistroVacunacion/GetTiposCarnet');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        console.error('Error al cargar tipos de carnet:', data.error);
                        return;
                    }

                    // Buscar el select de tipo de carnet
                    const select = document.getElementById('tipoCarnet');
                    if (!select) {
                        console.error('Select tipoCarnet no encontrado');
                        return;
                    }

                    // Ocultar indicador de carga si existe
                    const loading = document.getElementById('tipoCarnetLoading');
                    if (loading) {
                        loading.style.display = 'none';
                    }

                    // Preservar valor actual
                    const currentValue = select.value;

                    // Limpiar opciones existentes excepto la primera
                    select.innerHTML = '<option value="">Seleccione tipo de carnét</option>';

                    // Agregar las opciones desde la base de datos
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(tipoCarnet => {
                            const option = document.createElement('option');
                            option.value = tipoCarnet.value;
                            option.textContent = tipoCarnet.text;
                            option.setAttribute('data-codigo', tipoCarnet.codigo);

                            // Mantener la selección si existía
                            if (tipoCarnet.value == currentValue) {
                                option.selected = true;
                            }

                            select.appendChild(option);
                        });
                    } else {
                        console.warn('No se recibieron tipos de carnet');
                    }

                } catch (error) {
                    console.error('Error al cargar tipos de carnet:', error);

                    // Mostrar error en el select
                    const select = document.getElementById('tipoCarnet');
                    if (select) {
                        select.innerHTML = '<option value="">Error al cargar tipos de carnet</option>';
                    }

                    // Ocultar indicador de carga
                    const loading = document.getElementById('tipoCarnetLoading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }
            }

            // Función para validar datos básicos
            window.validateDatosBasicos = function () {
                const requiredFields = {
                    'NumeroDocumento': 'Número de Identificación',
                    'PrimerNombre': 'Primer Nombre',
                    'PrimerApellido': 'Primer Apellido',
                    'FechaNacimiento': 'Fecha de Nacimiento'
                };

                let isValid = true;
                let missingFields = [];

                // Primero limpiar todas las clases is-invalid de los campos
                Object.keys(requiredFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.classList.remove('is-invalid');
                    }
                });

                for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        isValid = false;
                        missingFields.push(fieldName);
                        if (field) {
                            field.classList.add('is-invalid');
                        }
                    }
                }

                return isValid;
            };

            // Hacer las funciones globalmente accesibles
            window.eliminarAntecedente = eliminarAntecedente;


            // Restaurar datos del paso inicial si existen
            setTimeout(() => {
                restoreCurrentStepData();
            }, 100);

            // Agregar listeners para guardar datos automáticamente cuando cambian
            const stepContainer = document.getElementById('step-container');
            if (stepContainer) {
                stepContainer.addEventListener('change', function (e) {
                    if (e.target.matches('input, select, textarea')) {
                        saveCurrentStepData();
                    }
                });

                stepContainer.addEventListener('input', function (e) {
                    if (e.target.matches('input, textarea')) {
                        saveCurrentStepData();
                    }
                });
            }

            // Agregar listener al formulario para manejar el envío
            const form = document.getElementById('vacunacionForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    // Guardar datos del paso actual
                    saveCurrentStepData();

                    // Recopilar todos los datos
                    const todosLosDatos = {};
                    for (let step = 1; step <= totalSteps; step++) {
                        const stepData = localStorage.getItem(`stepData_${step}`);
                        if (stepData) {
                            try {
                                const parsedData = JSON.parse(stepData);

                                // Convertir posibles valores de texto a booleanos reales
                                for (const [key, value] of Object.entries(parsedData)) {
                                    if (typeof value === "string") {
                                        const lowerValue = value.trim().toLowerCase();

                                        if (["true", "si", "sí", "on"].includes(lowerValue)) {
                                            parsedData[key] = true;
                                        } else if (["false", "no"].includes(lowerValue)) {
                                            parsedData[key] = false;
                                        }
                                    }
                                }

                                Object.assign(todosLosDatos, parsedData);
                            } catch (e) {
                                console.error(`Error al parsear datos del paso ${step}:`, e);
                            }
                        }
                    }

                    // Obtener los antecedentes de formData y agregarlos al objeto de envío
                    const formDataStr = localStorage.getItem('vacunacionFormData');
                    if (formDataStr) {
                        try {
                            const formDataObj = JSON.parse(formDataStr);
                            if (formDataObj.antecedentes && formDataObj.antecedentes.length > 0) {
                                // Convertir los antecedentes a un formato que el servidor pueda procesar
                                const antecedentesParaEnviar = formDataObj.antecedentes.map(ant => ({
                                    FechaRegistro: ant.fecha, // Usar la fecha original (yyyy-mm-dd)
                                    Tipo: ant.tipo,
                                    Descripcion: ant.descripcion,
                                    Observaciones: ant.observaciones === 'N/A' ? null : ant.observaciones,
                                    Activo: true
                                }));

                                // Agregar al objeto que se enviará al servidor
                                todosLosDatos.ArrayAntecedentes = JSON.stringify(antecedentesParaEnviar);
                            }
                        } catch (e) {
                            console.error('Error al procesar antecedentes:', e);
                        }
                    }


                    // Enviar via AJAX
                    const submitBtn = document.getElementById('submitBtn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="ri-loader-2-line spinner me-1"></i> Guardando...';
                    }

                    fetch('/RegistroVacunacion/GuardarRegistroCompleto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(todosLosDatos)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Limpiar localStorage
                                for (let step = 1; step <= totalSteps; step++) {
                                    localStorage.removeItem(`stepData_${step}`);
                                }
                                localStorage.removeItem('vacunacionFormData');

                                alert('Registro guardado correctamente');
                                window.location.href = '/RegistroVacunacion/Index';
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error al guardar el registro');
                        })
                        .finally(() => {
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="ri-save-line me-1"></i> Guardar Registro';
                            }
                        });
                });
            }

            const buscarBtn = document.getElementById('nextBtnBuscar');
            if (!buscarBtn) return;

            buscarBtn.addEventListener('click', async function (e) {
                e.preventDefault();

                const numeroInput = document.getElementById('NumeroDocumento');
                const tipoSelect = document.querySelector('select[name="TipoDocumento"]') || document.getElementById('TipoDocumento');
                const primerNombre = document.getElementById('PrimerNombre');
                const segundoNombre = document.getElementById('segundoNombre'); // ojo: en la vista está con minúscula inicial
                const primerApellido = document.getElementById('PrimerApellido');
                const segundoApellido = document.getElementById('SegundoApellido');
                const fechaNacimiento = document.getElementById('FechaNacimiento');

                if (!numeroInput) {
                    console.error('Input NumeroDocumento no encontrado');
                    return;
                }

                const identificacion = numeroInput.value && numeroInput.value.toString().trim();
                if (!identificacion) {
                    // mostrar validación simple
                    const vm = numeroInput.parentElement.querySelector('.validation-message');
                    if (vm) vm.style.display = 'block';
                    numeroInput.classList.add('is-invalid');
                    return;
                }

                // Llamada al endpoint
                try {
                    const url = `/Pacientes/BuscarPorIdentificacion?identificacion=${encodeURIComponent(identificacion)}`;
                    const resp = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                    if (!resp.ok) {
                        console.error('Respuesta no OK', resp.status);
                        alert('Error al consultar el paciente.');
                        return;
                    }
                    const json = await resp.json();
                    if (!json.success) {
                        alert(json.message || 'Paciente no encontrado.');
                        // Opcional: limpiar campos o permitir ingreso manual
                        return;
                    }

                    const data = json.data || {};
                    // Rellenar campos si existen
                    if (tipoSelect && data.TipoIdentificacion) {
                        // Intentar seleccionar la opción (valores: CC, TI, RC, PA, CE)
                        tipoSelect.value = data.TipoIdentificacion;
                        // disparar evento change si hay listeners
                        tipoSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    if (primerNombre && data.primerNombre) primerNombre.value = data.primerNombre;
                    if (segundoNombre && data.segundoNombre) segundoNombre.value = data.segundoNombre;
                    if (primerApellido && data.primerApellido) primerApellido.value = data.primerApellido;
                    if (segundoApellido && data.segundoApellido) segundoApellido.value = data.segundoApellido;
                    if (fechaNacimiento && data.fechaNacimiento) fechaNacimiento.value = data.fechaNacimiento;

                    // Limpiar validaciones visuales
                    [numeroInput, primerNombre, primerApellido, fechaNacimiento, tipoSelect].forEach(el => {
                        if (!el) return;
                        el.classList.remove('is-invalid');
                        const vm = el.parentElement?.querySelector('.validation-message');
                        if (vm) vm.style.display = 'none';
                    });

                } catch (err) {
                    console.error('Error consultando paciente:', err);
                    alert('Ocurrió un error al buscar el paciente. Revise la consola para más detalles.');
                }
            });

             function configurarCalculoEdad() {
                const fechaNacimientoInput = document.getElementById('FechaNacimiento');
                if (!fechaNacimientoInput) return;
                
                // Función para actualizar edad calculada
                function actualizarEdadCalculada() {
                    const edadContainer = document.getElementById('edadCalculada');
                    
                    if (!fechaNacimientoInput.value) {
                        if (edadContainer) {
                            edadContainer.style.display = 'none';
                        }
                        return;
                    }
                    
                    const fechaNacimiento = new Date(fechaNacimientoInput.value);
                    const edad = calcularEdad(fechaNacimiento);
                    
                    if (edad && edadContainer) {
                        // Mostrar el contenedor
                        edadContainer.style.display = 'block';
                        
                        // Actualizar los valores
                        const edadAnios = document.getElementById('edadAnios');
                        const edadMeses = document.getElementById('edadMeses');
                        const edadDias = document.getElementById('edadDias');
                        const totalMeses = document.getElementById('totalMeses');
                        const totalDias = document.getElementById('totalDias');
                        
                        if (edadAnios) edadAnios.textContent = edad.years;
                        if (edadMeses) edadMeses.textContent = edad.months;
                        if (edadDias) edadDias.textContent = edad.days;
                        if (totalMeses) totalMeses.textContent = edad.totalMonths;
                        if (totalDias) totalDias.textContent = `${edad.totalDays} días totales`;
                    }
                }
                
                // Agregar eventos al campo de fecha de nacimiento
                fechaNacimientoInput.addEventListener('change', actualizarEdadCalculada);
                fechaNacimientoInput.addEventListener('input', actualizarEdadCalculada);

                // Agregar eventos al campo de fecha de nacimiento
                fechaNacimientoInput.addEventListener('change', actualizarEdadCalculada);
                fechaNacimientoInput.addEventListener('input', actualizarEdadCalculada);
                
                // Calcular edad inicial si ya hay una fecha
                if (fechaNacimientoInput.value) {
                    actualizarEdadCalculada();
                }
            }

            

            window.configurarCalculoEdad = configurarCalculoEdad;

            window.activarFlujoVacunaRestaurada = activarFlujoVacunaRestaurada;
            window.calcularEdad = calcularEdad;
            window.renderRangos = renderRangos;
            window.rangoAplica = rangoAplica;
            window.mostrarAlertaSegunRangos = mostrarAlertaSegunRangos;
            window.toggleMarcarComoPerdida = toggleMarcarComoPerdida;
        })
    </script>
}