@model InsumoViewModel
@{
    ViewData["Title"] = "Gestión de Insumos";
    Layout = "~/Views/Shared/_VerticalLayout.cshtml";
}

<!-- Info Card -->
<div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <div class="avatar-sm">
                    <span class="avatar-title bg-white bg-opacity-20 text-white rounded-circle fs-3">
                        <i class="ri-medicine-bottle-line"></i>
                    </span>
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h5 class="mb-1 text-white">Gestión de Insumos</h5>
                <p class="text-white-50 mb-0">Configure y administre los insumos disponibles en el sistema.</p>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                            <i class="ri-medicine-bottle-line me-1"></i> Vacunas
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <h5 class="text-success fs-14 mb-0">
                            <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                        </h5>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-2">
                    <div>
                        <h2 class="fw-semibold ff-secondary mb-0">
                            <span class="counter-value" data-target="@Model.Insumos.Count(i => i.Tipo.ToLower() == "vacuna")">@Model.Insumos.Count(i => i.Tipo.ToLower() == "vacuna")</span>
                        </h2>
                        <a href="#" class="text-decoration-underline">Ver vacunas</a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-primary-subtle rounded fs-3">
                            <i class="ri-medicine-bottle-line text-primary"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                            <i class="ri-syringe-line me-1"></i> Jeringas
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <h5 class="text-info fs-14 mb-0">
                            <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                        </h5>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-2">
                    <div>
                        <h2 class="fw-semibold ff-secondary mb-0">
                            <span class="counter-value" data-target="@Model.Insumos.Count(i => i.Tipo.ToLower() == "jeringa")">@Model.Insumos.Count(i => i.Tipo.ToLower() == "jeringa")</span>
                        </h2>
                        <a href="#" class="text-decoration-underline">Ver jeringas</a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-info-subtle rounded fs-3">
                            <i class="ri-syringe-line text-info"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                            <i class="ri-drop-line me-1"></i> Goteros
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <h5 class="text-success fs-14 mb-0">
                            <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                        </h5>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-2">
                    <div>
                        <h2 class="fw-semibold ff-secondary mb-0">
                            <span class="counter-value" data-target="@Model.Insumos.Count(i => i.Tipo.ToLower() == "gotero")">@Model.Insumos.Count(i => i.Tipo.ToLower() == "gotero")</span>
                        </h2>
                        <a href="#" class="text-decoration-underline">Ver goteros</a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-success-subtle rounded fs-3">
                            <i class="ri-drop-line text-success"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                            <i class="ri-bookmark-line me-1"></i> Carnets
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <h5 class="text-warning fs-14 mb-0">
                            <i class="ri-arrow-right-up-line fs-13 align-middle"></i>
                        </h5>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-2">
                    <div>
                        <h2 class="fw-semibold ff-secondary mb-0">
                            <span class="counter-value" data-target="@Model.Insumos.Count(i => i.Tipo.ToLower() == "carnet")">@Model.Insumos.Count(i => i.Tipo.ToLower() == "carnet")</span>
                        </h2>
                        <a href="#" class="text-decoration-underline">Ver carnets</a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-warning-subtle rounded fs-3">
                            <i class="ri-bookmark-line text-warning"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Card -->
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <div class="avatar-sm">
                    <span class="avatar-title bg-primary-subtle text-primary rounded-circle fs-5">
                        <i class="ri-medicine-bottle-line"></i>
                    </span>
                </div>
            </div>
            <div class="flex-grow-1 ms-3">
                <h5 class="card-title mb-1">Insumos (@Model.TotalInsumos)</h5>
                <p class="text-muted mb-0">Gestione los insumos disponibles en el sistema</p>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Search and Filter Bar -->
        <div class="row g-3 mb-4">
            <div class="col-xxl-4 col-sm-5">
                <div class="search-box">
                    <input type="text" class="form-control search" placeholder="Buscar por código, nombre o descripción...">
                    <i class="ri-search-line search-icon"></i>
                </div>
            </div>
            <div class="col-xxl-2 col-sm-3">
                <div>
                    <select class="form-control" data-choices data-choices-search-false id="tipoFilter">
                        <option value="">Todos los tipos</option>
                        <option value="Vacuna">Vacuna</option>
                        <option value="Jeringa">Jeringa</option>
                        <option value="Diluyente">Diluyente</option>
                        <option value="Gotero">Gotero</option>
                        <option value="Carnet">Carnet</option>
                        <option value="Tarjeta">Tarjeta</option>
                    </select>
                </div>
            </div>
            <div class="col-xxl-2 col-sm-4">
                <div>
                    <select class="form-control" data-choices data-choices-search-false id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>
            </div>
            <div class="col-xxl-4 col-sm-12">
                <div class="d-flex gap-2">
                    <a asp-action="Create" class="btn btn-success add-btn">
                        <i class="ri-add-line align-bottom me-1"></i> Agregar
                    </a>
                    <button type="button" class="btn btn-primary" onclick="SearchData();">
                        <i class="ri-equalizer-fill me-1 align-bottom"></i> Filtros
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters();">
                        <i class="ri-refresh-line me-1 align-bottom"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible alert-label-icon fade show" role="alert">
                <i class="ri-check-double-line label-icon"></i><strong>Éxito</strong> - @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible alert-label-icon fade show" role="alert">
                <i class="ri-error-warning-line label-icon"></i><strong>Error</strong> - @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Table -->
        <div class="table-responsive table-card mb-1">
            <table class="table table-nowrap align-middle" id="insumoTable">
                <thead class="table-light text-muted">
                    <tr>
                        <th scope="col" style="width: 50px;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                            </div>
                        </th>
                        <th class="sort" data-sort="codigo">Código</th>
                        <th class="sort" data-sort="nombre">Nombre</th>
                        <th class="sort" data-sort="tipo">Tipo</th>
                        <th class="sort" data-sort="descripcion">Descripción</th>
                        <th class="sort" data-sort="rango_dosis">Rango/Dosis</th>
                        <th class="sort" data-sort="estado">Estado</th>
                        <th class="sort" data-sort="fecha_creacion">Fecha Creación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody class="list form-check-all">
                    @foreach (var item in Model.Insumos)
                    {
                        <tr>
                            <th scope="row">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="checkAll" value="@item.Id">
                                </div>
                            </th>
                            <td class="codigo">
                                <div class="d-flex align-items-center">
                                    <span class="fw-medium">@item.Codigo</span>
                                </div>
                            </td>
                            <td class="nombre">
                                <div class="d-flex align-items-center">
                                    <span class="fw-medium text-primary">@item.Nombre</span>
                                </div>
                            </td>
                            <td class="tipo">
                                <span class="@item.TipoBadgeClass">@item.Tipo</span>
                            </td>
                            <td class="descripcion">
                                <span class="text-muted">@(item.Descripcion ?? "N/A")</span>
                            </td>
                            <td class="rango_dosis">
                                <span class="text-muted">@(item.RangoDosis ?? "N/A")</span>
                            </td>
                            <td class="estado">
                                <span class="@item.EstadoClass">@item.EstadoTexto</span>
                            </td>
                            <td class="fecha_creacion">
                                <span class="text-muted">@item.FechaCreacion.ToString("yyyy-MM-dd")</span>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <div class="edit">
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-success">
                                            <i class="ri-pencil-fill align-bottom"></i>
                                        </a>
                                    </div>
                                    <div class="remove">
                                        <button class="btn btn-sm btn-danger remove-item-btn" 
                                                onclick="eliminarInsumo(@item.Id, '@item.Codigo')">
                                            <i class="ri-delete-bin-fill align-bottom"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (!Model.Insumos.Any())
            {
                <div class="noresult text-center py-4">
                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                    <h5 class="mt-2">¡Lo siento! No se encontraron resultados</h5>
                    <p class="text-muted mb-3">No hay insumos registrados en el sistema.</p>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i> Agregar Primer Insumo
                    </a>
                </div>
            }
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-end">
            <div class="pagination-wrap hstack gap-2">
                <a class="page-item pagination-prev disabled" href="javascript:void(0);">
                    Anterior
                </a>
                <ul class="pagination listjs-pagination mb-0"></ul>
                <a class="page-item pagination-next" href="javascript:void(0);">
                    Siguiente
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Eliminar -->
<div class="modal fade zoomIn" id="deleteRecordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close"></button>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>¿Está seguro?</h4>
                        <p class="text-muted mx-4 mb-0">¿Está seguro de que desea eliminar este insumo?</p>
                        <p class="text-muted mx-4 mb-0" id="delete-record-text"></p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <form id="deleteForm" method="post" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn w-sm btn-danger">Sí, Eliminar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/libs/list.js/list.min.js"></script>
    <script src="~/libs/list.pagination.js/list.pagination.min.js"></script>
    
    <script>
        function eliminarInsumo(id, codigo) {
            document.getElementById('delete-record-text').innerText = 'Código: ' + codigo;
            document.getElementById('deleteForm').action = '@Url.Action("Delete", "Insumo")/' + id;
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteRecordModal'));
            deleteModal.show();
        }

        // Initialize list.js for search and pagination
        var options = {
            valueNames: ['codigo', 'nombre', 'tipo', 'descripcion', 'rango_dosis', 'estado', 'fecha_creacion'],
            page: 10,
            pagination: true
        };

        var contactList = new List('insumoTable', options);

        // Search functionality
        document.querySelector('.search').addEventListener('input', function(e) {
            contactList.search(e.target.value);
        });

        // Filter functionality
        function SearchData() {
            var tipo = document.getElementById('tipoFilter').value;
            var estado = document.getElementById('statusFilter').value;
            
            contactList.filter(function(item) {
                var tipoMatch = !tipo || item.values().tipo.toLowerCase().includes(tipo.toLowerCase());
                var estadoMatch = !estado || (estado === 'true' && item.values().estado.toLowerCase().includes('activo')) || (estado === 'false' && item.values().estado.toLowerCase().includes('inactivo'));
                return (!tipo || tipoMatch) && (!estado || estadoMatch);
            });
        }

        function clearFilters() {
            document.getElementById('tipoFilter').value = '';
            document.getElementById('statusFilter').value = '';
            contactList.filter();
            contactList.search();
        }

        // Counter animation
        document.addEventListener('DOMContentLoaded', function() {
            const counters = document.querySelectorAll('.counter-value');
            counters.forEach(counter => {
                const target = parseInt(counter.getAttribute('data-target'));
                const increment = target / 100;
                let current = 0;
                
                const updateCounter = () => {
                    if (current < target) {
                        current += increment;
                        counter.textContent = Math.ceil(current);
                        setTimeout(updateCounter, 20);
                    } else {
                        counter.textContent = target;
                    }
                };
                
                updateCounter();
        });
    </script>
}